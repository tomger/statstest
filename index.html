
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Covid</title>
    <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, sans-serif;
          display: flex;
          justify-content: center;
          background: #fff;
        }
        .wrapper {
          width: 100%;
          max-width: 500px;
          overflow: hidden;
          
        }
   
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 6px;
            padding-right: 20px;
            font-size: 12px;
            color: #fff;
            background: #000;
            border: 0px;
            pointer-events: none;
            font-weight: 300;
        }
        svg {overflow: visible}
     

        .axis line {
          stroke: #fff;
        }
        .axis .domain{
          stroke: #aaa;
          stroke-width: .5px;
        }
        .axis {
          font-size: 12px;
          font-weight: 500;
          color: #aaa;
        }
        .x-axis .tick text{
          transform: translateY(8px);
        }
        .y-axis .domain{
          /* stroke: #fff; */
          /* text-anchor: start; */
        }
        body, html {
          padding: 0; margin: 0
        }
        .columns {
          display: flex;
          flex-direction: column;
        }
        .graph > div > h3 {
          font-size: 16px;
          font-weight: 600;
          margin: 0 0 16px 0;
        }
        .graph > div{
          background: #fff;
          padding: 16px 16px 16px 16px;
          /* border-bottom:1px solid #eee; */
          margin: 12px 0;
        }
        .noTicks .tick {
          display: none;
        }
    
        .menu {
          position: absolute;
          top: 0;
          z-index: 2;
          display: none;
          padding: 10px;
          background: #fafafa;
          width: 100%;
        }
        .button {
          line-height: 40px;
          padding: 0 14px;
          border: 1px solid #eee;
          border-radius: 8px;
          margin-right: 8px
        }
        .titlebar {
          font-size: 20px; 
          font-weight: 700;
          line-height: 30px;
          margin: 20px 16px 16px 16px;
          border-bottom: 1px solid #ddd;
          padding-bottom: 20px;;
        }
        .titlebar span {
          display: inline-block;
          font-weight: 300;
          color: #888;
        }

        .legend {
          font-size: 14px;
          font-weight: 300;
          line-height: 32px;
        }
        .legend > div {
          padding: 8px 0 8px 0;
          border-bottom: 1px solid #ccc;
          display:flex;justify-content: space-between;
          font-size:16px;
        }
        .state_selector_wrapper {

          border: #ccc; 
          border-radius: 8px;
          background: #f0f0f3;
          box-sizing: border-box;
          margin: 40px 16px 20px 16px;
          line-height: 44px;;
          text-align: center;
          font-size: 14px;
          font-weight: 500;;
          /* width: 100%; */
          position: relative;
        }
        .state_selector {

          width: 100%;
          -moz-appearance: none;
	        -webkit-appearance: none;
          opacity: 0;
          left:0;
          height: 44px;
          position: absolute;
        }

        .lastupdated {
        }
        .info {
          padding: 16px;
          font-size: 12px;
          font-weight: 300;
          color: #999;
          margin-bottom: 50px;
        }
        .info a {
          color: #777
        }
        .loading {
          padding: 16px;
          font-size: 16px;
        }
    </style>

</head>
<body>
      <div class="wrapper">
        <div class="titlebar">COVID-19 <span>Customizable dashboard</span></div>
        <div class="graph">

        </div>
        <div class="loading">
          Collecting latest data... hold on...
        </div>
        <div class="state_selector_wrapper" style="display: none">
            <select class="state_selector" onChange="toggleState(this.value)"></select>
            Add
        </div>

        <div class="info">
          United States data provided by <a href="https://github.com/nytimes/covid-19-data">The New York Times</a>. World data provided by <a href="https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide">European Centre for Disease Prevention and Control</a>. <span class="lastupdated"></span>.
        </div>
      </div>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
    const appState = {
        covidData: null,
        populationData: null,
        selectedStates: ["New York", "Germany", "Brazil"]
    };
    try {
      let storage =  localStorage.getItem('states0');
      if (storage) {
        appState.selectedStates = localStorage.getItem('states0').split(',')
      }
    } catch(e) {}

    renderTotalOverTime();
    renderMenu();

    getLastUpdate().then(lastUpdate => {
      d3.select('.lastupdated').html(`Last refreshed data on ${new Date(lastUpdate.date).toLocaleDateString()}`)
    })

    function toggleState(state) {
      if (!state) {
        return
      }
      let index = appState.selectedStates.indexOf(state);
      if (index === -1) {
        appState.selectedStates.push(state)
      } else {
        appState.selectedStates.splice(index, 1)
      }
      localStorage.setItem('states0', appState.selectedStates)
      renderMenu()
      renderTotalOverTime();
    }

    async function renderMenu() {
      let statesMenu = [
        ...new Set((await getCovidDataUS()).map(line => line.state)),
        ...new Set((await getCovidDataEU()).map(line => line.countriesAndTerritories))
      ].sort();

      list = statesMenu
        .filter((name) => appState.selectedStates.indexOf(name) === -1)
        .map(function(name){
          return `<option value="${name}">${name}</option>`;
        }).join('')
        d3.select(".state_selector").html(`<option value="">Add a state</option>` + list)
    }

    // function resetMenu() {
    //   appState.selectedStates = [];
    //   localStorage.setItem('states0', appState.selectedStates)
    //   renderMenu();
    //   renderTotalOverTime();
    // }


    const tooltipDiv = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

    window.onresize = function () {
        renderTotalOverTime(appState.currentState);
    }


    async function renderTotalOverTime () {
        const formatDate = d3.timeFormat("%B %e");
        let states = appState.selectedStates;
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10).domain(states);
        // const colors = ["#510000", "#879772", "#325d8a", "#6C6ACB", "#DF9F22",]
        const colors = ["#2E4F60","#226C5B","#637F3E","#B5843D"];
        // const colors = ["#000", "#000", "#000", "#000", "#879772",]
        d3.select('.state_selector_wrapper').style('display', 'block')
        d3.select('.loading').style('display', 'none')
        var graphs = d3.select(".graph").html("")
        const width = (document.querySelector(".wrapper").offsetWidth - 32);
        const height = 130;
        for (let i = 0; i < states.length; i++) {
          let graph = graphs.append("div")
            .attr('style', "position:relative")
              

          graph.append('h3')
              .html(`${states[i].replace(/_/g, " ")}`)
              
          graph.append('div')
              .attr('style', "position:absolute;top: 22px; right: 14px")
              .html(`<svg  xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#bbb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>`)
              .on('click', toggleState.bind(this, states[i]));

          let columns = graph.append('div').attr('class', 'columns');


          let state_data = await getCovidDataForState(states[i]);
          // let variables = ['rollingDeaths', 'rollingCases'];
          let variables = ['rollingDeaths', 'rollingCases', 'rollingTests'].filter(variable => {
            return !!state_data[0][variable];
          });
          variables.forEach(async function (variable, variableIndex) {
            let nonRollingVar = ['dailyDeathsPerCapita', 'dailyCasesPerCapita', 'dailyTestsPerCapita'][variableIndex];
            let variableTitle = ['New deaths', 'New cases', 'New tests'][variableIndex];
            let maxY = d3.max(state_data, function(d) { return d[nonRollingVar]; })
            let minY = d3.min(state_data, function(d) { return d[nonRollingVar]; })
            let state_svg = columns.append("svg")
                .html("")
                .attr("width", width )
                .attr("height", variableIndex < variables.length ? height-20:height);
            let minX = d3.min(state_data, function(d) { return d.date; })
            let maxX = d3.max(state_data, function(d) { return d.date; });

            const xScaleBand = d3.scaleBand()
              .range([0, width/50])
              .padding(0)
              .paddingInner(0.00)
              .align(.5)
              .domain([minX, maxX]);

            const xScale =
                    d3.scaleTime()
                      .range([0, width])
                      .domain([minX, maxX]);
              state_svg.append("g")
                  .attr("class", `axis x-axis ${variableIndex < variables.length -1 ? "noTicks" : ""}`)
                  .style("font-family", "-apple-system, BlinkMacSystemFont, sans-serif")
                  .attr("transform", "translate(0," + (height-20) + ")")
                  .call(d3.axisBottom(xScale)
                    .tickValues( xScale.ticks( 0 ).concat( xScale.domain() ) )
                    .tickFormat(formatDate).tickSize(0))

              state_svg.append("g")
                  .attr("class", `axis x-axis`)
                  .attr("transform", "translate(0, 0)")
                  .call(d3.axisBottom(xScale).tickValues( xScale.ticks( 0 )).tickSize(0))
              state_svg.selectAll(".x-axis .tick text").style("text-anchor", "start")
              state_svg.selectAll(".x-axis .tick:last-child text").style("text-anchor", "end");

     
            const yScale = d3.scaleLinear()
                  .range([height-20 , 0])
                  .domain([0, maxY*1.3]);
            let last_item = state_data[state_data.length -1];
            let first_item = state_data[0];
            let y1 = Math.min(yScale(first_item[variable]), yScale(last_item[variable]));
            let y2 = Math.max(yScale(first_item[variable]), yScale(last_item[variable]));
            let color = first_item[variable] > last_item[variable] ? '#2ca02c' : '#d62728';
            if (variable === 'rollingTests') {
              color = "#333"
            }

            state_svg.append("g")
                .attr("class", "axis y-axis")
                .attr("transform", `translate(${width}, 0)`)
                .call(d3.axisRight(yScale).tickValues(yScale.ticks(0)).tickSize(0) ); //2
              state_svg.append("g")
                .attr("class", "axis y-axis")
                .attr("transform", `translate(0, 0)`)
                .call(d3.axisLeft(yScale).tickValues(yScale.ticks(0) ).tickSize(0));


            state_svg.append("line")
              .style('stroke', "#ccc")
              .attr("stroke-dasharray", 4)
              .attr("stroke-width", 0.5)
              .attr('x1', xScale(first_item.date))
              .attr('y1', yScale(last_item[variable]) == y1 ? y2 : y1)
              .attr('x2', xScale(last_item.date))
              .attr('y2', yScale(last_item[variable]) == y1 ? y2 : y1);

            // state_svg.append("rect")
            //   .style('opacity', 0.05)
            //   .style('fill', color)
            //   .attr('x', xScale(first_item.date))
            //   .attr('y', y1)
            //   .attr('width', xScale(last_item.date))
            //   .attr('height', y2 - y1);



            // if (Math.abs( (yScale(last_item[variable]) == y2 ? y2 : y1) - (height-20) ) > 15) {
            //   state_svg.append("g").append('text')
            //   .attr("transform", `translate(${ width- 40 }, ${height-18})`)
            //   .style('font-size', '12px')
            //   .style('font-weight', 500)
            //   .style('fill', "#aaa")
            //   .html(0);
            // }

            function round(n) {
              if (n > 10) {
                return Math.round(n);
              }
              return Math.round(n*100)/100;
            }

            let startvalue = yScale(last_item[variable]) == y2 ? y1 : y2;
            let endvalue = yScale(last_item[variable]) == y2 ? y2 : y1;
            // if (Math.abs(y1 - y2) > 10 || yScale(last_item[variable]) == y2 ) {




            // // if (Math.abs(y1 - y2) > 10 || yScale(last_item[variable]) == y1 ) {
            //   state_svg.append("g").append('text')
            //     .attr("transform", `translate(${yScale(last_item[variable]) == y1 ? width- 40 : -3 }, ${Math.round(y1+4)})`)
            //     .attr("text-anchor", yScale(last_item[variable]) == y1 ? "start" : "end")
            //     .style('font-size', '12px')
            //     .style('font-weight', 500)
            //     .style('fill', yScale(last_item[variable]) == y1 ? '#000' : "#fff")
            //     .html(round(yScale.invert(y1)));

            // // }

            state_svg
              .selectAll('rect')
              .data(state_data.slice(0, state_data.length-1))
              .enter()
              .append("rect")
              .attr("fill", color)
              .attr("opacity", .1)
              .attr("x", function(d) { return xScale(d.date); })
              .attr("y", function(d) { return yScale(d[nonRollingVar]); })
              .attr("width", xScaleBand.bandwidth()*1.3)
              .attr("height", function(d) { return (height-20) - yScale(d[nonRollingVar]); });


            state_svg
              .datum(state_data)
              .append("path")
              .attr("opacity", .05)
              .attr("fill", color)
              .attr("d", d3.area()
                  .x(function(d) { 
                    return xScale(d.date) 
                  })
                  .y0(height-20)
                  .y1(function(d) {
                    return yScale(d[variable])
                  })
              )
              
            state_svg
                .datum(state_data)
                .append("path")
                .attr("fill", "none")
                .attr("stroke", color)
                .attr("stroke-width",1.55)
                .attr("d", d3.line()
                    .x(function(d) { 
                      return xScale(d.date) 
                    })
                    .y(function(d) {
                      return yScale(d[variable])
                    })
                )



            let summary_pos = 16; //height -28 
            let summary = last_item[variable] > first_item[variable] ? `↗${Math.round(100*((last_item[variable]-first_item[variable])/first_item[variable]))}%` : `↘${Math.abs(Math.round(100*((last_item[variable]-first_item[variable])/first_item[variable])))}%`
            // if (endvalue <= 40) {
              // summary += `<tspan style="fill:#000"> · ${round(yScale.invert(endvalue))}/1M</tspan>`
            // }

            // state_svg.append("g").append('text')
            //   .attr("transform", `translate(${width-6},${summary_pos})`)
            //   .attr("text-anchor", "end")
            //   .style('font-size', '12px')
            //   .style('font-weight', 500)
            //   .style('opacity', 1)
            //   .style('fill', color)
            //   .html(summary)

            state_svg.append("g").append('circle')
              .attr('cx' , xScale(last_item['date']))
              .attr('cy' , yScale(last_item[variable]))
              .attr('r' , 3)
              .style('fill', color)
              .style('stroke', "#fff");

            
            state_svg.append("g").append('text')
              .attr("transform", `translate(7,${summary_pos})`)
              .style('font-size', '12px')
              .style('font-weight', 500)
              .style('opacity', 1)
              .style('fill', '#000')
              .html(`${variableTitle} · ${summary}`);


          // if (endvalue > 40) {
            state_svg.append("g").append('text')
              .attr("transform", `translate(${width + 16 }, ${ endvalue-10})`)
              .attr("text-anchor", "end")
              .style('font-size', '12px')
              .style('font-weight', 500)
              .style('fill', '#000')
              .style('stroke', '#fff')
              .style('stroke-width', '3')
              .style('stroke-linecap', 'butt')
              .style('paint-order', 'stroke')
              .style('stroke-linejoin', 'miter')
              .html(`${round(yScale.invert(endvalue))}/1M`);
            // }
          })

        
       
           
        }
 
    }

    async function getCovidDataForState(state) {
      let population = 0;
      let needsDailyDeathCalculation = false;
      let data = [];

      try {
        population = await getPopulationDataForState(state)
        needsDailyDeathCalculation = true;

      } catch(e) {
        console.log(`${state} not found in US NST`)
      }

      let dataus = await getCovidDataUS()
      // XXX US death data is cummulative
      // date: "2020-02-25"
      // state: "Wisconsin"
      // fips: "55"
      // cases: "1"
      // deaths: "0"

      let dataeu = await getCovidDataEU()
      // dateRep: "29/03/2020"
      // day: "29"
      // month: "3"
      // year: "2020"
      // cases: "11"
      // deaths: "1"
      // countriesAndTerritories: "Albania"
      // geoId: "AL"
      // countryterritoryCode: "ALB"
      // popData2018: "2866376"

      let dataTestingUS = await getTestingDataForState(state) // enable for testing data
      dataTestingUS.forEach(line => {
        // 20200430
        if (line.date.substr) {
          line.date = new Date(`${line.date.substr(0,4)}-${line.date.substr(4,2)}-${line.date.substr(6,2)}T12:00:00Z`)
        }
      })


      data = dataus.filter(line => line.state === state);
      data.forEach(line => {
        if (typeof line.date == 'string') {
          line.date = new Date(`${line.date}T12:00:00Z`)
        }


        line.testing = dataTestingUS.find(testing => testing.date.getTime() == line.date.getTime())
        if (line.testing) {
          line.dailyTestsPerCapita = (line.testing.totalTestResultsIncrease / population) * 1000000;

        }
      })
      // console.log(data, dataTestingUS)
      dataeu
        .filter(line => line.countriesAndTerritories === state)
        .forEach(line => {
          population = line.popData2019;
          data.push({
            date: new Date(`${line.year}-${pad(line.month)}-${pad(line.day)}T12:00:00Z`),
            state: line.countriesAndTerritories,
            dailyCases: line.cases,
            dailyCasesPerCapita: (line.cases / line.popData2019) * 1000000,
            dailyDeaths: line.deaths,
            dailyDeathsPerCapita: (line.deaths / line.popData2019) * 1000000
          })
      })

      data = data.sort((a,b) => {
            if(a.date == b.date) return 0
            else if(new Date(a.date) > new Date(b.date)) return 1
            else return -1
          });

      if (needsDailyDeathCalculation) {
        data.forEach((day, index) => {
          if (!data[index-1]) {
            day.dailyCases = null;
            day.dailyCasesPerCapita = null;
            day.dailyDeaths = null;
            day.dailyDeathsPerCapita = null;
          } else {
            day.dailyCases = day.cases - data[index-1].cases
            day.dailyCasesPerCapita = (day.dailyCases / population) * 1000000
            day.dailyDeaths = day.deaths - data[index-1].deaths
            day.dailyDeathsPerCapita = (day.dailyDeaths / population) * 1000000
          }
        })

      }

      data.forEach((line, index) => {
        const before = 4;
        const after = 4;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rollingDeaths = average(data.slice(start, end), "dailyDeathsPerCapita")
      })

      data.forEach((line, index) => {
        const before = 4;
        const after = 4;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rollingCases = average(data.slice(start, end), "dailyCasesPerCapita")
      })

      data.forEach((line, index) => {
        const before = 4;
        const after = 4;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rollingTests = average(data.slice(start, end), "dailyTestsPerCapita")
      })

      let dayCutOff = 61;
      let cutOff = Date.now() - dayCutOff *  24*60*60*1000;
      data = data.filter(day => new Date(day.date) > cutOff)


      return data;
    }



    async function getPopulationDataForState(state) {
      let data = await getPopulationData()
      data = data.filter(line => line.NAME === state)
      return data[0].CENSUS2010POP;
    }

    async function getPopulationData() {
        appState.populationData = appState.populationData
            ? appState.populationData
            : d3.csv("nst-est2019-alldata.csv")
        return await appState.populationData
    }

    async function getTestingDataForState(state) {
      const map = {
        "New York": "NY",
        "Kansas": "KS",
        "Colorado": "CO",
      }
      let data = await getTestingDataUS()
      data = data.filter(line => line.state === map[state])
      return data;
    }

    async function getTestingDataUS() {
        if (!appState.usTestingData) {
          appState.usTestingData = d3.csv(`us-testing.csv?cache=${new Date().getDate()}-${new Date().getHours()}`);
          appState.usTestingData.then(data => {
            appState.usTestingData = data;
            renderTotalOverTime(); // XXX terrible
          })
          return await [];
        } else if (appState.usTestingData instanceof Array) {
          return await appState.usTestingData
        } else {
          return await [];
        }

    }

    async function getLastUpdate() {
        return (await d3.csv("lastupdate"))[0]
    }

    async function getCovidDataUS() {
        appState.covidData = appState.covidData
            ? appState.covidData
            : d3.csv(`us-states.csv?cache=${new Date().getDate()}-${new Date().getHours()}`)

        return await appState.covidData
    }

    async function getCovidDataEU() {
        appState.covidDataEu = appState.covidDataEu
            ? appState.covidDataEu
            : d3.csv(`eu-states.csv?cache=${new Date().getDate()}-${new Date().getHours()}`)

        return await appState.covidDataEu
    }

    function sum(numbers, prop) {
      return numbers.reduce((a, b) => {
        return a + b[prop]
      }, 0);
    }

    function pad(num) {
        var s = num+"";
        while (s.length < 2) s = "0" + s;
        return s;
    }

    function average(numbers, prop) {

      return sum(numbers, prop) / (numbers.length || 1);
    }


</script>
</html>
