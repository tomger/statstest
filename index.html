
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>COVID-19 Watchlist</title>
    <style>
        :root {
          --colorBackground: #ffffff;
          --colorSecondaryBackground: #ebebf0;
          --colorLabel: #000;
          --colorSecondaryLabel: #6e6e73;
          --colorSeparator: #e5e5ea;
          --colorSeparatorTranslucent: #6d6d8530;

          --colorRed: #cc3a00;
          --colorGreen: #1d9422;
        }

        * {
          box-sizing: border-box;
        }

        @media (prefers-color-scheme: dark) {
            :root {
            --colorBackground: #000003;
            --colorSecondaryBackground: #212124; /*1C1C1E*/
            --colorLabel: #fff;
            --colorSecondaryLabel: rgb(101, 102, 105);
            --colorSeparator: #222;
            --colorSeparatorTranslucent: #6d6d8530;
          }
        }
      
        body {
          font-family: -apple-system, BlinkMacSystemFont, sans-serif;
          display: flex;
          width: 100%;
          align-items: center;
          flex-direction: column;
          background: var(--colorBackground);
          color: var(--colorLabel);
        }

        svg {overflow: visible}
     
        .axis line {
          stroke: transparent;
        }
        .axis .domain{
          stroke: #aaa;
          stroke-width: .5px;
        }
        .axis {
          font-size: 12px;
          font-weight: 500;
          color: #aaa;
        }
        .x-axis .tick text{
          transform: translateY(8px);
        }
        .y-axis .domain{
          /* stroke: #fff; */
          /* text-anchor: start; */
        }
        body, html {
          padding: 0; margin: 0
        }
        .columns {
          display: flex;
          flex-direction: column;
        }
        .graph-wrapper {
          position:relative;
          scroll-margin-top: 70px;
        }
        .graph > div > h3 {
          font-size: 16px;
          font-weight: 600;
          margin: 0 0 16px 0;
        }

        .graph > div > h3 a {
          color: var(--colorLabel);
          text-decoration: none
        }
        .graph > div{
          background: var(--colorBackground);
          padding: 16px 16px 16px 16px;
          /* border-bottom:1px solid #eee; */
          margin: 12px 0;
        }
        .noTicks .tick {
          display: none;
        }
        a {
          color: var(--colorLabel);
          outline: none
        }
        
        .button {
          line-height: 40px;
          padding: 0 14px;
          border: 1px solid #eee;
          border-radius: 8px;
          margin-right: 8px
        }

        .wrapper {
          width: 100%;
          flex:1;
          max-width: 500px;
          overflow: hidden;
          padding: 0 16px;
        }

        .titlebar {
          padding: 0 16px 0 16px;
          box-sizing: border-box;
          flex: 1;
          max-width: 500px;
          line-height: 26px;
          margin: 12px 0 16px 0;
          

          display: flex;
          flex-direction: row;
          justify-content: space-between;
        }
        .titlebar-header {
          text-decoration: none;
        }
        .titlebar-header > div:first-child{
          font-size: 20px; 
          font-weight: 800;
          display: block;
        }
        .titlebar-subheader {
          font-size: 20px;
          font-weight: 800;
          opacity: 0.5;
          line-height: 14px;
        }
        .header-add {
          display: flex;align-items: center;padding: 0 10px;
          position:relative;

        }
        .titlebar-feedback {
          border: 1px solid rgb(187, 204, 241);
          text-decoration: none;
          font-size: 14px;
          padding: 4px 8px;
          border-radius: 5px;;
          color: blue
        }
        .titlebar span {
          display: inline-block;
          font-weight: 400;
          /* color: #888; */
        }

        .legend {
          font-size: 14px;
          font-weight: 300;
          line-height: 32px;
        }
        .legend > div {
          padding: 8px 0 8px 0;
          border-bottom: 1px solid #ccc;
          display:flex;justify-content: space-between;
          font-size:16px;
        }
        .state_selector_wrapper {

          border: #ccc; 
          border-radius: 8px;
          background: #f0f0f3;
          box-sizing: border-box;
          margin: 40px 16px 20px 16px;
          line-height: 44px;;
          text-align: center;
          font-size: 14px;
          font-weight: 500;;
          /* width: 100%; */
          position: relative;
        }
        .travel-high {
          color: #de7c00
        }
        .state_selector {

          width: 100%;
          -moz-appearance: none;
	        -webkit-appearance: none;
          opacity: 0;
          left:0;
          height: 44px;
          position: absolute;
        }

        .lastupdated {
        }
        .info {
          -webkit-text-size-adjust: none;
          font-size: 12px;
          line-height: 16px;
          font-weight: 400;
          color: #999;
          margin-bottom: 50px;
          margin-top: 30px;
        }
        .info a {
          color: #777
        }

        /*NEW*/
        .searchinput {
          font-size: 16px;
          outline: none;
          border: none;
          background-color: var(--colorSecondaryBackground);
          line-height: 32px;
          padding: 2px 12px 2px 32px;
          border-radius: 8px;
          color: var(--colorLabel);
          margin: 5px 0 20px 0;
          background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
          background-repeat: no-repeat;

          background-position: 7px 9px;
          background-size: 18px;
          width: 100%;
          transition: width 250ms ease;
          -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        .search-bar {
          white-space: nowrap;
        }

        .search-cancel {
          width: 60px;
          text-align: center;
          display: inline-block;
          opacity: 0;
          -webkit-tap-highlight-color: rgba(0,0,0,0);
        }


        .search-bar.isFocussed .searchinput {
          width: calc(100% - 60px);
        }

        .search-bar.isFocussed .search-cancel {
          opacity: 1;
        }

        @media (prefers-color-scheme: dark) {
          .searchinput {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#aaaaaa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
          }
        }
        .menuitem-wrapper {
          padding: 12px 0;
          display: flex;
          border-bottom: 0.5px solid var(--colorSeparator);
          cursor: pointer;
        }
        .menuitem-wrapper > div:first-child{ 
          flex: 1
        }

        .isUp {
          color: var(--colorRed)
        }

        .isDown {
          color: var(--colorGreen)
        }

        .titlebar-wrapper {
          border-bottom: 1px solid var(--colorSeparatorTranslucent);
          width: 100%;
          display: flex;
          justify-content: center;
          margin-bottom: 16px;
          position: -webkit-sticky;
          z-index: 2;
          top: 0;
          background: var(--colorBackground);
          overflow: hidden;
          transition: all 250ms ease-in-out;
          /* transform: translateY (0px); */

        }
        @media (prefers-color-scheme: dark) {
          .titlebar-wrapper {
            background: rgba(0,0,0,0.8);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
          }
        }

        .titlebar-wrapper.isHidden {
          margin-top: -70px;
          /* position: absolute; */
          transform: translateY(-70px);
          opacity: 0;
        }
        .primaryLabel {
          color: var(--colorLabel);
          font-size: 17px;
          font-weight: 500;
        }
        .secondaryLabel {
          color: var(--colorSecondaryLabel);
          font-size: 14px;
        }

        .marketing {
          padding: 12px 12px 12px 12px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 8px;
          margin: 20px 0;
          display: flex;
          align-content: center;
          width: 100%;
          align-items: center;
          background:#e29c05;
          color: var(--colorBackground);
        }
        .marketing svg {
          color: var(--colorBackground);
          margin-right: 16px;
        }

    </style>

</head>
<body>
      <div class="wrapper">
        <detail-view></detail-view>
      </div>
      <div class="titlebar-wrapper">
        <div class="titlebar">
          <a class="titlebar-header" href="#top">
            <div>COVID-19</div>
            <div class="titlebar-subheader">Watchlist</div>
          </a>
          
          <div class="header-add">
            
          </div>
        </div>
      </div>
      <div class="wrapper listing-wrapper">
        <div class="search-bar">
          <input 
            class="searchinput" 
            autocomplete="off"
            autocorrect="off"
            placeholder="Search"
            onfocus="onSearchFocus()"
            oninput="onSearchInput(event)"/>
          <a
            class="search-cancel"
            onclick="onSearchCancel()"
            >Cancel</a>
        </div>
        <search-view></search-view>

        <div class="info">
          <span class="lastupdated"></span>United States data provided by <a href="https://github.com/nytimes/covid-19-data">The New York Times</a>. World data provided by <a href="https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide">European Centre for Disease Prevention and Control</a>.
        </div>
      </div>

</body>
<script src="/d3.v5.min.js"></script>
<script>

function onSearchFocus() {
  document.querySelector('.titlebar-wrapper').classList.add('isHidden')
  document.querySelector('.search-bar').classList.add('isFocussed')
  searchView.isSearching = true
}

function onSearchCancel() {
  document.querySelector('.searchinput').value='';
  document.querySelector('.titlebar-wrapper').classList.remove('isHidden')
  document.querySelector('.search-bar').classList.remove('isFocussed')
  searchView.query = null
  searchView.isSearching = false
}

function onSearchInput(event) {
  searchView.query = event.target.value;
}

function init() {
  loadRegions();
  d3.csv("/lastupdate").then(data => {
    document.querySelector('.lastupdated').innerHTML = `Last updated on ${data[0].date}. `;
  })
}

function loadRegions() {
  d3.csv("/data/regions.csv").then(data => {
    searchView.regions = data;

    let region = getRegionFromLocation();
    if (region) {
      showDetailView(region)
    }
  });
}

window.onpopstate = function() {
  let region = getRegionFromLocation();
  showDetailView(region);

}

function getRegionFromLocation() {
  // let pathname = '/region/us-st-maine';
  let pathname = location.pathname;
  let pathMatch = pathname.match(/region\/(.*)/);
  if (pathMatch) {
    let needlePath = pathMatch[1];
    let region = searchView.regions.find(line => line.path === needlePath);
    return region;
  }
  return null;
}

function closeDetailView() {
  history.replaceState({}, 'COVID-19 Watchlist', `/`)
  showDetailView(null)
}
function navigateToDetailView(region) {
  didPushHistoryState = true;
  history.pushState({}, region.name, `/region/${region.path}`)
  showDetailView(region)
}

function showDetailView(region) {
  [...document.querySelectorAll('.listing-wrapper, .titlebar-wrapper')].forEach(e => {
    e.style.display = !!region ? 'none' : ''
  })
  detailView.region = region;
}

function readSettings() {
  try {
      let storage =  localStorage.getItem('states0');
      if (storage) {
        return localStorage.getItem('states0').split(',')
      }
  } catch(e) {
  }
  return [];
}

function isRegionSelected(state) {
  return selectedRegions.indexOf(state) !== -1;
}

function toggleRegion(state) {
  if (!state) {
    return
  }
  let index = selectedRegions.indexOf(state);
  if (index === -1) {
    selectedRegions.push(state)
  } else {
    selectedRegions.splice(index, 1)
  }
  localStorage.setItem('states0', selectedRegions.join(','))

  // DEBUG
  searchView.update();
  onSearchCancel();
}

function changeNumber(region) {
  let change = region['change-cases'];
  return /*html*/`
    <div class="${change < 0 ? 'isDown' : 'isUp'}">
      ${change > 0 ? '+' : ''}${change}%
    </div>
  `;
}

function numberColumn(region) {
  const warnSign = `
  <svg width="13" height="12" viewBox="0 0 13 12" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M6.02051 2.52216C6.45587 1.82595 7.54427 1.82595 7.97963 2.52216L12.6326 9.96293C13.0679 10.6591 12.5237 11.5294 11.653 11.5294H2.34714C1.47642 11.5294 0.932221 10.6591 1.36758 9.96293L6.02051 2.52216ZM7.8266 9.43878C7.8266 9.89526 7.45655 10.2653 7.00007 10.2653C6.54359 10.2653 6.17354 9.89526 6.17354 9.43878C6.17354 8.9823 6.54359 8.61224 7.00007 8.61224C7.45655 8.61224 7.8266 8.9823 7.8266 9.43878ZM7.00007 4.47959C6.5674 4.47959 6.23829 4.8681 6.30942 5.29488L6.67927 7.51395C6.7054 7.67077 6.84109 7.78571 7.00007 7.78571C7.15905 7.78571 7.29474 7.67077 7.32087 7.51395L7.69072 5.29488C7.76185 4.8681 7.43274 4.47959 7.00007 4.47959Z" fill="#EAAF17"/>
</svg>


  `;

  let relativeCases = ((region['last-cases'] / region.population) * 100000).toFixed(1);
  let changeRow = '<span class="secondaryLabel">–</span>';
  if (relativeCases > 1) {
    changeRow = changeNumber(region)
  }
  return /*html*/`
    <div style="text-align: right; font-size: 14px; width: 54px;">
      <div>${relativeCases > 10 ? warnSign : '' }${relativeCases}</div>${changeRow}
    </div>
  `;
}

class SearchView extends HTMLElement {
  constructor() {
    super();
    this.style.display = "block";
    this.style.transition = "opacity 50ms ease";
    // console.log(this.getAttribute("filter"));
  }
  // static get observedAttributes() {
  //   return ["filter"];
  // }
  // attributeChangedCallback(name, oldValue, newValue) {
  //   // do something when an attribute has changed
  // }

  // this.dispatchEvent(new CustomEvent("clicked", {
  //       detail: this._timesClicked
  // }));

  // var button = document.createElement("button");
  // button.textContent = "Click me";
  // this.append(button);



  update() {
    let root = d3.select(this);
    // let menuitem = menu.append('a').attr('href', `#${state_name}`);
    // menuitem.append('div').html(`<span class="state-name">${state_name.replace(/_/g, " ")}</span> <svg style="position:relative; top: 2px" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-terminal"><polyline points="6 19 12 13 6 7"></polyline></svg>`);
    // menuitem.append('div').attr('class', yScale.invert(endvalue) > 100 ? 'travel-high': '').html(`${(round100(yScale.invert(endvalue)/10)).toLocaleString()} `);
    // let last_column = menuitem.append('div').attr('style', 'white-space: nowrap').html(`<span style="display:inline-block; xfont-size:12px;color: ${color}">${summary}</span>`);

    if (this.isSearching && this.query) {
      this.innerHTML = ``;
      this.style.opacity = "1";

      this._regions
        .filter(region => {
          return region.name.toLowerCase().indexOf(this.query.toLowerCase()) !== -1;
        })
        .sort((a, b) => {
          return b.population - a.population;
        })
        .slice(0, 20)
        .forEach(region => {
          let menuitem = root.append('div')
              .attr('class', `menuitem-wrapper`)
              .on('click', function() { 
                navigateToDetailView(region) 
              })
              .html(/*html*/`
                <div>
                  <div class="primaryLabel">${region.name.replace(/_/g, ' ')}</div>
                  <div class="secondaryLabel">
                      ${region.byline}${region.byline ? ' · ' : ''}${Number(region.population).toLocaleString()}
                  </div>
                </div>
                ${numberColumn(region)}
              `);  
        })
    } else {
      if (this.isSearching) {
        this.style.opacity = ".2";
      } else {
        this.style.opacity = "1";
      }
      this.innerHTML = ``;
     
      let selectedRegions = this._regions
        .filter(region => {
          return isRegionSelected(region.path)
        });
      selectedRegions
        .sort((a, b) => {
          return (a['last-cases'] / a.population) - (b['last-cases'] / b.population)
        })
        .forEach(region => {
          const sparkStyle = `
            padding-top: 2px;
            margin-right: 5px;
            display: flex;
            align-items: center
          `;
          let menuitem = root.append('div')
              .attr('class', `menuitem-wrapper`)
              .on('click', function() { 
                navigateToDetailView(region) 
              })
              .html(/*html*/`
              <div>
                <div class="primaryLabel">${region.name.replace(/_/g, ' ')}</div>
                <div class="secondaryLabel">
                  ${region.byline}${region.byline ? ' · ' : ''}${Number(region.population).toLocaleString()}
                </div>
              </div>
              <div style="${sparkStyle}">
                <spark-line class="${region["change-cases"] < 0 ? 'isDown' : 'isUp'}" src="/data/${region.path}.csv"></spark-line>
              </div>
              ${numberColumn(region)}
          `);
        })

        if (selectedRegions.length < 2) {

          root.append('div').attr('class', 'marketing').html(/*html*/`
            <svg width="48" height="48" viewBox="0 0 54 54" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M27 54C41.9117 54 54 41.9117 54 27C54 12.0883 41.9117 0 27 0C12.0883 0 0 12.0883 0 27C0 41.9117 12.0883 54 27 54ZM13.7656 23.4922V21.5859H16.5391V23.4922H18.0703V25.5312H16.5391V29.1016C16.5391 29.6875 16.8516 29.9844 17.5156 29.9844C17.7344 29.9844 17.8984 29.9766 18.0625 29.9453V31.9141C17.7969 31.9688 17.3906 32.0156 16.8516 32.0156C14.6406 32.0156 13.7656 31.3359 13.7656 29.6641V25.5312H12.6094V23.4922H13.7656ZM22.0312 32H19.2578V20.7266H22.0312V32ZM26.5234 25.4531C26.5234 26.2578 25.875 26.9062 25.0703 26.9062C24.2656 26.9062 23.625 26.2578 23.625 25.4531C23.625 24.6484 24.2656 24 25.0703 24C25.875 24 26.5234 24.6484 26.5234 25.4531ZM26.5234 29.9609L25.4844 34.5859H23.4766L23.9688 29.9609H26.5234ZM33.7969 30.5391C33.4531 31.4453 32.4688 32.125 31.2031 32.125C29.0859 32.125 27.8125 30.4766 27.8125 27.7266C27.8125 25.0078 29.1094 23.3672 31.2344 23.3672C32.4688 23.3672 33.4062 24.0391 33.7812 24.9922H33.8359V20.7266H36.6016V32H33.8516V30.5391H33.7969ZM33.8438 27.75C33.8438 26.3828 33.2344 25.5312 32.2422 25.5312C31.25 25.5312 30.6484 26.3828 30.6484 27.75C30.6484 29.125 31.2422 29.9609 32.2422 29.9609C33.2422 29.9609 33.8438 29.1328 33.8438 27.75ZM40.7344 32H37.9609V23.4922H40.6562V25.1016H40.7109C41.0234 23.9531 41.7109 23.3672 42.7109 23.3672C42.9922 23.3672 43.2266 23.4062 43.4141 23.4766V25.8359C43.1797 25.7422 42.8594 25.6797 42.5312 25.6797C41.3672 25.6797 40.7344 26.3359 40.7344 27.5234V32Z" fill="currentColor"/>
            </svg>
            <div>No frills new cases & warnings tracker. Add countries, US States & US Counties to your list.</div>
          `)
        }
    }
    

  }


  set isSearching(value) {
    this._isSearching = value;
    this.update();
  }

  get isSearching() {
    return this._isSearching;
  }

  set query(value) {
    this._query = value;
    this.update();
  }

  get query() {
    return this._query;
  }

  set regions(value) {
    this._regions = value;
    this.update();
  }

  get regions() {
    return this._regions;
  }
}

customElements.define("search-view", SearchView);



class DetailView extends HTMLElement {
  constructor() {
    super();
  }

  drawChart(node, data) {
    const width = node.node().getBoundingClientRect().width;
    const height = width / 2.2;
    const color = 'currentColor';

    let svg = node.append("svg")
      .html("")
      .attr("width", width)
      .attr("height", height)

    let values = movingAverage(data.map(d => parseInt(d.cases, 10)));
    const scaleX = d3.scaleLinear().range([0, width]).domain([0, values.length]);
    const scaleY = d3.scaleLinear().range([height, 0]).domain([
    0, d3.max(values)
    ]);

    svg.append("g")
      .attr("transform", `translate(0, 0)`)
      .call(d3.axisRight(scaleY).tickValues(scaleY.ticks(5))) //.ticks(2)
      .call(g => g.selectAll(".tick text")
        .attr('color', 'var(--colorSecondaryLabel)')
        .attr("transform", `translate(-2, -7)`))
      .call(g => g.selectAll(".tick line")
        .attr('x2', width))
        .attr('color', 'var(--colorSecondaryLabel)')
        .attr('stroke-dasharray', 4)
        .attr('style', 'opacity:.5')
      .call(g => g.selectAll(".domain").attr('stroke', 'transparent'))

    svg.append("g")
      .call(d3.axisBottom(scaleX).tickValues(scaleX.ticks(5))) // ticks(2)
      .call(g => g.selectAll(".tick text")
        .attr('color', 'var(--colorSecondaryLabel)')
        .attr("transform", `translate(0, ${height})`))
      .call(g => g.selectAll(".tick line")
        .attr('y2', height))
        .attr('color', 'var(--colorSecondaryLabel)')
        .attr('style', 'opacity:.5')
      .call(g => g.selectAll(".domain").attr('stroke', 'transparent'))

    svg
      .datum(values)
      .append("path")
      .attr("fill", "none")
      .attr("stroke", color)
      .attr("stroke-width",1.75)
      .attr("d", d3.line()
          .x(function(d, i) { 
            return scaleX(i);
          })
          .y(function(d) {  
            return scaleY(d)
          })
      )

  }

  update() {
    if (!this.region) {
      this.style.display = "none";
      return;
    }
    this.style.cssText = `
      padding: 20px;
    `;

    let cases = Number((this._region['last-cases'] / this.region.population) * 100000).toFixed(1);
    let bigNumberStyle = /*css*/`
      font-size: 28px;
      font-weight: 600;
    `;
    let bigNumberCaptionStyle = /*css*/`
      font-size: 12px;
      color: var(--colorSecondaryLabel);
    `
    let numberWrapperStyle = /*css*/`
      display: flex; 
      flex-direction: row;
      border: 1px solid var(--colorSeparator);
      border-width: 1px 0 1px 0;
      padding: 16px 0;
      gap: 40px;
    `;
    let captionStyle = ``;
    const iff = (condition, result) => condition ? result : '';
    let removeButton = /*html*/`
      <div style="padding: 20px 0; border-bottom: 1px solid var(--colorSeparator)">
        <div onclick="toggleRegion('${this._region.path}');closeDetailView()">
          Remove from watchlist
        </div>
      </div>
    `;
    let addButton = `<div 
      onclick="toggleRegion('${this._region.path}');closeDetailView()"
      style="font-size: 14px;
      font-weight: 600; display: inline-block;padding: 8px 12px;
      border-radius: 40px;background: #1d5ab5; color: var(--colorBackground)">
      Add to watchlist
    </div>`;
    this.innerHTML = /*html*/`
      <div style="display:flex; flex-direction: row">
        <div onClick="closeDetailView()" style="width: 44px; height: 44px; flex: 1">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </div>
        <div 
        onclick="navigator.share({title: 'COVID-19 Watchlist: ${this.region.name}', text: '', url: location.href})"
        style="margin-right: 10px;text-decoration: underline;font-size: 14px; font-weight: 600; display: inline-block;padding: 8px 12px; border-radius: 40px; ">
          Share
          </div>
        <div>
          ${iff(!isRegionSelected(this.region.path), addButton)}
        </div>
      </div>
      <div style="font-size: 30px; margin-top: 32px; margin-bottom: 12px; font-weight: 700;">
        ${this._region.name}
      </div>
      <div style="padding-bottom: 20px; color: var(--colorSecondaryLabel); font-size: 13px; margin: -12px 0 0px 0">
        ${this.region.byline ? this.region.byline + ' · ' : ''}
        ${Number(this.region.population).toLocaleString()} residents
      </div>
      <div style="${numberWrapperStyle}">
        <div style="flex: 1">
          <div style="${captionStyle}">New cases</div>
          <div style="${bigNumberStyle}">${cases}</div>
          <div style="${bigNumberCaptionStyle}">Last 7 day average per 100k residents</div>
        </div>
        <div style="flex: 1">
          <div style="${captionStyle}">Last 30 days</div>
          <div style="${bigNumberStyle}">${changeNumber(this.region)}</div>
          <div style="${bigNumberCaptionStyle}">First and last 7 day averages compared</div>
        </div>
      </div>
      <div class="chart-view" style="padding: 20px 0;">
      </div>
      ${iff(isRegionSelected(this.region.path), removeButton)}
      <div class="table-view" style="padding: 20px 0;">
      </div>
    `;

    d3.csv(`/data/${this.region.path}.csv`).then(data => {
      d3.select('.chart-view').html(`<div style="margin-bottom: 20px">${data[0].date} to ${data[29].date}</div>`)
      this.drawChart(d3.select('.chart-view'), data)
      d3.select('.table-view').append('table').attr('style', `font-size: 13px;`).html(
        `<tr><td>Date</td><td>New cases</td><td>New cases per 100k</td></tr>` +
        data.map(l => {
          return `<tr><td style="color:var(--colorSecondaryLabel) ">${l.date}</td><td>${l.cases}</td><td>${Number((l.cases / this.region.population) * 100000).toFixed(1)}</td></tr>`
        }).join('')
      )
    })

  }

  set region(value) {
    this._region = value;
    this.update();
  }

  get region() {
    return this._region;
  }
}
customElements.define("detail-view", DetailView);


function sum(array) {
  return array.reduce((a, b) => {
    return a + b;
  }, 0);
}

function average(array) {
  return sum(array) / (array.length || 1);
}

function movingAverage(array) {
  const before = 0;
  const after = 3;
  return array.map((line, index) => {
    const start = Math.max(0, index - before);
    const end   = Math.min(array.length, index + after + 1);
    return average(array.slice(start, end))
  })
}


class SparklineElement extends HTMLElement {
  constructor() {
    super();
    const width = this.getAttribute('width') ||  60;
    const height = this.getAttribute('height') || 24;
    const color = this.getAttribute('color') || 'currentColor';
    d3.csv(this.getAttribute('src')).then(data => {
      this.innerHTML = ''
      let svg = d3.select(this).append("svg")
        .html("")
        .attr("width", width)
        .attr("height", height)

      let values = movingAverage(data.map(d => parseInt(d.cases, 10)));
      const scaleX = d3.scaleLinear().range([0, width]).domain([0, values.length]);
      const scaleY = d3.scaleLinear().range([height, 0]).domain([
      d3.min(values), d3.max(values)
      ]);
      svg
        .datum(values)
        .append("path")
        .attr("fill", "none")
        .attr("stroke", color)
        .attr("stroke-width",1.75)
        .attr("d", d3.line()
            .x(function(d, i) { 
              return scaleX(i);
            })
            .y(function(d) {  
              return scaleY(d)
            })
        )
    })
  }

}
customElements.define("spark-line", SparklineElement);



let didPushHistoryState = false;
const searchView = document.querySelector('search-view');
const detailView = document.querySelector('detail-view');
const selectedRegions = readSettings();
init();

</script>
</html>
