
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>COVID-19 Watchlist</title>
    <style>
        :root {
          --colorBackground: #ffffff;
          --colorLabel: #1d1d1f;
          --colorSecondaryLabel: #6e6e73;
          --colorSeparator: #e5e5ea;
        }
      
        body {
          font-family: -apple-system, BlinkMacSystemFont, sans-serif;
          display: flex;
          justify-content: center;
          background: var(--colorBackground);
          color: var(--colorLabel);
        }
        .wrapper {
          width: 100%;
          max-width: 500px;
          overflow: hidden;
          
        }

        svg {overflow: visible}
     
        .axis line {
          stroke: #fff;
        }
        .axis .domain{
          stroke: #aaa;
          stroke-width: .5px;
        }
        .axis {
          font-size: 12px;
          font-weight: 500;
          color: #aaa;
        }
        .x-axis .tick text{
          transform: translateY(8px);
        }
        .y-axis .domain{
          /* stroke: #fff; */
          /* text-anchor: start; */
        }
        body, html {
          padding: 0; margin: 0
        }
        .columns {
          display: flex;
          flex-direction: column;
        }
        .graph > div > h3 {
          font-size: 16px;
          font-weight: 600;
          margin: 0 0 16px 0;
        }

        .graph > div > h3 a {
          color: #000;
          text-decoration: none
        }
        .graph > div{
          background: #fff;
          padding: 16px 16px 16px 16px;
          /* border-bottom:1px solid #eee; */
          margin: 12px 0;
        }
        .noTicks .tick {
          display: none;
        }
        a {
          color: var(--colorLabel);
          outline: none
        }
        .menu {
          padding: 16px;
          display: flex;
          flex-wrap: wrap;
          flex-direction: column;
          font-size: 14px;
          font-variant-numeric: tabular-nums;
        }
        .menu > a,
        .menu > div.menu-header
        {
          line-height: 30px;
          padding: 4px 0;
          display: flex;
          justify-content: space-between;
          flex-direction: row;
          width: 100%;
          border-bottom: 1px solid var(--colorSeparator);
        }
        .menu > div.menu-header {
          font-size: 12px;
          color:var(--colorSecondaryLabel);
          font-weight: 300;
          text-transform: uppercase;
          line-height: 14px;
        }
        .menu > * > div:first-child {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        .menu > * > div:nth-child(2) {
          text-align: right;
          width: 90px;
          flex: 1;
        }

        .menu > * > div:nth-child(3) {
          text-align: right;

          width: 110px;
          flex-shrink: 0;
        }

        .menu a {
          text-decoration: none;
        }
        .button {
          line-height: 40px;
          padding: 0 14px;
          border: 1px solid #eee;
          border-radius: 8px;
          margin-right: 8px
        }
        .titlebar {

          line-height: 26px;
          margin: 20px 16px 16px 16px;
          padding-bottom: 20px;
          display: flex;
          flex-direction: row;
          justify-content: space-between;
        }
        .titlebar-header > div:first-child{
          font-size: 20px; 
          font-weight: 800;
          display: block;
        }
        .titlebar-subheader {
          font-size: 13px;
          font-weight: 300;;
          color: var(--colorSecondaryLabel);
          line-height: 14px;
        }
        .header-add {
          display: flex;align-items: center;padding: 0 10px;
          position:relative;

        }
        .titlebar-feedback {
          border: 1px solid rgb(187, 204, 241);
          text-decoration: none;
          font-size: 14px;
          padding: 4px 8px;
          border-radius: 5px;;
          color: blue
        }
        .titlebar span {
          display: inline-block;
          font-weight: 400;
          /* color: #888; */
        }

        .legend {
          font-size: 14px;
          font-weight: 300;
          line-height: 32px;
        }
        .legend > div {
          padding: 8px 0 8px 0;
          border-bottom: 1px solid #ccc;
          display:flex;justify-content: space-between;
          font-size:16px;
        }
        .state_selector_wrapper {

          border: #ccc; 
          border-radius: 8px;
          background: #f0f0f3;
          box-sizing: border-box;
          margin: 40px 16px 20px 16px;
          line-height: 44px;;
          text-align: center;
          font-size: 14px;
          font-weight: 500;;
          /* width: 100%; */
          position: relative;
        }
        .state_selector {

          width: 100%;
          -moz-appearance: none;
	        -webkit-appearance: none;
          opacity: 0;
          left:0;
          height: 44px;
          position: absolute;
        }

        .lastupdated {
        }
        .info {
          padding: 16px;
          font-size: 12px;
          font-weight: 300;
          color: #999;
          margin-bottom: 50px;
        }
        .info a {
          color: #777
        }
        .loading {
          padding: 16px;
          font-size: 16px;
        }
    </style>

</head>
<body>
      <div class="wrapper">
        <div class="titlebar">
          <div class="titlebar-header">
            <div>COVID-19 <span>Watchlist</span></div>
            <div class="titlebar-subheader">Daily updates from CDC, NYT and ECDC</div>
          </div>
          
          <div class="header-add">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <select class="state_selector" onChange="toggleState(this.value)"></select>
          </div>
        </div>
        <div class="menu"></div>
        <div class="graph">

        </div>
        <div class="loading">
          Collecting latest data... hold on...
        </div>
        <div class="state_selector_wrapper" style="display: none">
          
            <select class="state_selector" onChange="toggleState(this.value)"></select>
            Add
        </div>

        <div class="info">
          United States data provided by <a href="https://github.com/nytimes/covid-19-data">The New York Times</a>. World data provided by <a href="https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide">European Centre for Disease Prevention and Control</a>. <span class="lastupdated"></span>.
        </div>
      </div>
</body>
<script src="d3.v5.min.js"></script>
<script>

const yesterday = new Date();
      // yesterday.setDate(15) // DEBUG
      // yesterday.setMonth(5) // DEBUG
      yesterday.setDate(yesterday.getDate() -1);
      const lastMonth = new Date(yesterday);
      lastMonth.setMonth(lastMonth.getMonth() - 1);
      lastMonth.setDate(lastMonth.getDate() - 1);

    const appState = {
        covidData: null,
        populationData: null,
        selectedStates: ["New York", "Germany", "Brazil"]
    };
    try {
      let storage =  localStorage.getItem('states0');
      if (storage) {
        appState.selectedStates = localStorage.getItem('states0').split(',')
      }
    } catch(e) {}

    renderTotalOverTime();
    renderMenu();

    getLastUpdate().then(lastUpdate => {
      d3.select('.lastupdated').html(`Last refreshed data on ${new Date(lastUpdate.date).toLocaleDateString()}`)
    })

    function toggleState(state) {
      if (!state) {
        return
      }
      let index = appState.selectedStates.indexOf(state);
      if (index === -1) {
        appState.selectedStates.push(state)
      } else {
        appState.selectedStates.splice(index, 1)
      }
      localStorage.setItem('states0', appState.selectedStates)
      renderMenu()
      renderTotalOverTime();
    }

    async function renderMenu() {
      let statesMenu = [
        'New York City',
        ...new Set((await getCovidDataUS()).map(line => line.state)),
        ...new Set((await getCovidDataEU()).map(line => line.countriesAndTerritories))
      ].sort();

      list = statesMenu
        .filter((name) => appState.selectedStates.indexOf(name) === -1)
        .map(function(name){
          return `<option value="${name}">${name}</option>`;
        }).join('')
        d3.selectAll(".state_selector").html(`<option value="">Add to watchlist</option>` + list)
    }

    // function resetMenu() {
    //   appState.selectedStates = [];
    //   localStorage.setItem('states0', appState.selectedStates)
    //   renderMenu();
    //   renderTotalOverTime();
    // }


    const tooltipDiv = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

    window.onresize = function () {
        renderTotalOverTime(appState.currentState);
    }

     function round(n) {
              if (n > 10) {
                return Math.round(n);
              }
              return Math.round(n*100)/100;
    }
    async function renderTotalOverTime () {
        const formatDate = d3.timeFormat("%B %e");
        let states = appState.selectedStates;
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10).domain(states);
        // const colors = ["#510000", "#879772", "#325d8a", "#6C6ACB", "#DF9F22",]
        const colors = ["#2E4F60","#226C5B","#637F3E","#B5843D"];
        // const colors = ["#000", "#000", "#000", "#000", "#879772",]
        var graphs = d3.select(".graph").html("")
        const width = (document.querySelector(".wrapper").offsetWidth - 32);
        const height = 130;
        const menu = d3.select('.menu');
        menu.html(`<div class="menu-header"><div style="text-align:right;width:calc(100% - 106px);">New Cases<div style="opacity: .6;text-transform: initial; line-height: 10px; font-size: 10px; white-space: nowrap; margin-bottom: 5px;">per million on ${d3.timeFormat("%b %e")(yesterday)}</div></div><div>Last 30 days <div style="opacity: .6;text-transform: initial; line-height: 10px; font-size: 10px; white-space: nowrap; margin-bottom: 5px;">${d3.timeFormat("%b %e")(new Date(lastMonth).setDate(lastMonth.getDate()+1))} – ${d3.timeFormat("%b %e")(yesterday)}</div></div></div>`);

        let state_datas = [];
        for (let i = 0; i < states.length; i++) {
          state_datas.push({
            name: states[i],
            data: await getCovidDataForState(states[i])
          })
        }
        state_datas.sort((a, b) => {
          let aC = a.data[a.data.length-1];
          let bC = b.data[b.data.length-1];
          return aC.rollingCases - bC.rollingCases;
        });


        for (let i = 0; i < state_datas.length; i++) {
          let state_data = state_datas[i].data;
          let state_name = state_datas[i].name;
          d3.select('.state_selector_wrapper').style('display', 'block')
          d3.select('.loading').style('display', 'none')
          let graph = graphs.append("div")
            .attr('style', "position:relative")
              
 
          graph.append('h3')
              .html(`<a name="${state_name}" href="#${state_name}">${state_name.replace(/_/g, " ")}</a>`)
              
          graph.append('div')
              .attr('style', "position:absolute;top: 22px; right: 14px")
              .html(`<svg  xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#bbb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-square"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>`)
              .on('click', toggleState.bind(this, state_name));

          let columns = graph.append('div').attr('class', 'columns');


          
          // let variables = ['rollingDeaths', 'rollingCases'];
          let variables = [
            {
              variable: 'rollingCases',
              nonRolling: 'dailyCasesPerCapita',
              title: 'New cases',
              denominator: 'per million',
            },   
            {
              variable: 'rollingDeaths',
              nonRolling: 'dailyDeathsPerCapita',
              title: 'New deaths',
              denominator: 'per million',
            },
            {
              variable: 'rollingTests',
              nonRolling: 'dailyTestsPerCapita',
              title: 'New tests',
              denominator: 'per million',
            },    
            {
              variable: 'hospitalCapacity',
              nonRolling: 'hospitalCapacity',
              title: 'Est ICU usage',
              yScale: 100,
              denominator: 'percent of ICUs',
            },        
            ].filter(variableObj => {
            return !isNaN(state_data[0][variableObj.variable]);
          });

          variables.forEach(async function (variableObj, variableIndex) {
            let variable = variableObj.variable;
            let nonRollingVar = variableObj.nonRolling;
            let variableTitle = variableObj.title;
            let maxY = variableObj.yScale || d3.max(state_data, function(d) { return Math.max(d[nonRollingVar], d[variable]); })
            let minY = d3.min(state_data, function(d) { return d[nonRollingVar]; })
            let state_svg = columns.append("svg")
                .html("")
                .attr("width", width )
                .attr("height", variableIndex < variables.length ? height-20:height);
            let minX = d3.min(state_data, function(d) { return d.date; })
            let maxX = d3.max(state_data, function(d) { return d.date; });

            const xScaleBand = d3.scaleBand()
              .range([0, width/22])
              .padding(0)
              .paddingInner(0.00)
              .align(.5)
              .domain([minX, maxX]);

            const xScale =
                    d3.scaleTime()
                      .range([0, width])
                      .domain([minX, maxX]);
              state_svg.append("g")
                  .attr("class", `axis x-axis ${variableIndex < variables.length -1 ? "noTicks" : ""}`)
                  .style("font-family", "-apple-system, BlinkMacSystemFont, sans-serif")
                  .attr("transform", "translate(0," + (height-20) + ")")
                  .call(d3.axisBottom(xScale)
                    .tickValues( xScale.ticks( 0 ).concat( xScale.domain() ) )
                    .tickFormat(formatDate).tickSize(0))

              state_svg.append("g")
                  .attr("class", `axis x-axis`)
                  .attr("transform", "translate(0, 0)")
                  .call(d3.axisBottom(xScale).tickValues( xScale.ticks( 0 )).tickSize(0))
              state_svg.selectAll(".x-axis .tick text").style("text-anchor", "start")
              state_svg.selectAll(".x-axis .tick:last-child text").style("text-anchor", "end");

     
            const yScale = d3.scaleLinear()
                  .range([height-20 , 0])
                  .domain([0, maxY*1.3]);
            let last_item = state_data[state_data.findIndex(item => item[variable] === undefined) -1] || state_data[state_data.length -1];

            // let last_item = ;
            let first_item = state_data[0];
            let y1 = Math.min(yScale(first_item[variable]), yScale(last_item[variable]));
            let y2 = Math.max(yScale(first_item[variable]), yScale(last_item[variable]));


            let direction = (last_item[variable] - first_item[variable]) / first_item[variable];
            let color =  '#6d6b64'
            if (Math.abs(direction) > 0.2) {
              let smaller = first_item[variable] > last_item[variable];
              if (variable == 'rollingTests') {
                smaller = !smaller;
              }
              color = smaller ? '#1d9422' : '#cc3a00';
            }

            state_svg.append("g")
                .attr("class", "axis y-axis")
                .attr("transform", `translate(${width}, 0)`)
                .call(d3.axisRight(yScale).tickValues(yScale.ticks(0)).tickSize(0) ); //2
              state_svg.append("g")
                .attr("class", "axis y-axis")
                .attr("transform", `translate(0, 0)`)
                .call(d3.axisLeft(yScale).tickValues(yScale.ticks(0) ).tickSize(0));


            state_svg.append("line")
              .style('stroke', "#ddd")
              .attr("stroke-dasharray", 4)
              .attr("stroke-width", 1)
              .attr('x1', xScale(first_item.date))
              .attr('y1', yScale(last_item[variable]) == y1 ? y2 : y1)
              .attr('x2', xScale(last_item.date))
              .attr('y2', yScale(last_item[variable]) == y1 ? y2 : y1);

            // state_svg.append("rect")
            //   .style('opacity', 0.05)
            //   .style('fill', color)
            //   .attr('x', xScale(first_item.date))
            //   .attr('y', y1)
            //   .attr('width', xScale(last_item.date))
            //   .attr('height', y2 - y1);



            // if (Math.abs( (yScale(last_item[variable]) == y2 ? y2 : y1) - (height-20) ) > 15) {
            //   state_svg.append("g").append('text')
            //   .attr("transform", `translate(${ width- 40 }, ${height-18})`)
            //   .style('font-size', '12px')
            //   .style('font-weight', 500)
            //   .style('fill', "#aaa")
            //   .html(0);
            // }

     

            let startvalue = yScale(last_item[variable]) == y2 ? y1 : y2;
            let endvalue = yScale(last_item[variable]) == y2 ? y2 : y1;
            // if (Math.abs(y1 - y2) > 10 || yScale(last_item[variable]) == y2 ) {




            // // if (Math.abs(y1 - y2) > 10 || yScale(last_item[variable]) == y1 ) {
            //   state_svg.append("g").append('text')
            //     .attr("transform", `translate(${yScale(last_item[variable]) == y1 ? width- 40 : -3 }, ${Math.round(y1+4)})`)
            //     .attr("text-anchor", yScale(last_item[variable]) == y1 ? "start" : "end")
            //     .style('font-size', '12px')
            //     .style('font-weight', 500)
            //     .style('fill', yScale(last_item[variable]) == y1 ? '#000' : "#fff")
            //     .html(round(yScale.invert(y1)));

            // // }

            state_svg
              .selectAll('rect')
              .data(state_data.slice(0, state_data.length-1)) // one bar overlaps bug XXX
              .enter()
              .append("g")
              .attr("opacity", .05)
              .append("rect")
              .attr("x", function(d) { return xScale(d.date); })
              .attr("y", function(d) { return yScale(d[nonRollingVar]); })
              .attr("fill", color)
              .attr("rx", 3)
              .attr("ry", 3)
              .attr("width", xScaleBand.bandwidth()*1.3)
              .attr("height", function(d) { return (height-20) - yScale(d[nonRollingVar]); });


            state_svg
              .datum(state_data.slice(0, state_data.indexOf(last_item)+1))
              .append("path")
              .attr("opacity", .1)
              .attr("fill", color)
              .attr("d", d3.area()
                  .x(function(d) { 
                    return xScale(d.date) 
                  })
                  .y0(height-20)
                  .y1(function(d) {
                    return yScale(d[variable])
                  })
              )
            
            state_svg
                .datum(state_data)
                .append("path")
                .attr("fill", "none")
                .attr("stroke", color)
                .attr("stroke-width",1.55)
                .attr("d", d3.line()
                    .x(function(d) { 
                      return xScale(d.date) 
                    })
                    .y(function(d) {
                      return yScale(d[variable])
                    })
                )



            let summary_pos = 16; //height -28 
            let summary = last_item[variable] > first_item[variable] ? `↑${Math.round(100*((last_item[variable]-first_item[variable])/first_item[variable]))}%` : `↓${Math.abs(Math.round(100*((last_item[variable]-first_item[variable])/first_item[variable])))}%`
            // if (endvalue <= 40) {
              // summary += `<tspan style="fill:#000"> · ${round(yScale.invert(endvalue))}/1M</tspan>`
            // }

            // state_svg.append("g").append('text')
            //   .attr("transform", `translate(${width-6},${summary_pos})`)
            //   .attr("text-anchor", "end")
            //   .style('font-size', '12px')
            //   .style('font-weight', 500)
            //   .style('opacity', 1)
            //   .style('fill', color)
            //   .html(summary)

            state_svg.append("g").append('circle')
              .attr('cx' , xScale(last_item['date']))
              .attr('cy' , yScale(last_item[variable]))
              .attr('r' , 3)
              .style('fill', color)
              .style('stroke', "#fff");

            
            state_svg.append("g").append('text')
              .attr("transform", `translate(7,${summary_pos})`)
              .style('font-size', '12px')
              .style('font-weight', 500)
              .style('opacity', 1)
              .style('fill', '#000')
              .html(`${variableTitle} <tspan style="fill: ${color}">${summary}</tspan>`);


          // if (endvalue > 40) {
            state_svg.append("g").append('text')
              .attr("transform", `translate(${width -5 }, ${ endvalue-18})`)
              .attr("text-anchor", "end")
              .style('font-size', '12px')
              .style('font-weight', 500)
              .style('fill', '#000')
              .style('stroke', '#fff')
              .style('stroke-width', '4')
              .style('stroke-linecap', 'butt')
              .style('paint-order', 'stroke')
              .style('stroke-linejoin', 'miter')
              .html(`${round(yScale.invert(endvalue))}<tspan x="0" dy="11" style="font-weight: 300;fill: #999">${variableObj.denominator}</tspan>`);
            // }


            if (variable === 'rollingCases'){
                if (state_name === 'Belgium') {
                  console.log(state_data)
                }
            let menuitem = menu.append('a').attr('href', `#${state_name}`);
            menuitem.append('div').html(`${state_name.replace(/_/g, " ")} <svg style="position:relative; top: 2px" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-terminal"><polyline points="6 19 12 13 6 7"></polyline></svg>`);
            // menuitem.append('div').html(`${round(Number(last_item.dailyCases)).toLocaleString()} `);
            menuitem.append('div').html(`${Number(Math.round(yScale.invert(endvalue))).toLocaleString()} `);
            let last_column = menuitem.append('div').attr('style', 'white-space: nowrap').html(`<span style="display:inline-block; xfont-size:12px;color: ${color}">${summary}</span>`);
            // last_column.append(trend_svg);
            let trend_svg = last_column.append("svg")
                .html("")
                .attr("width", 36 )
                .attr("height", 20)
                .attr("style", "position:relative; top: 4px; margin-left: 6px;");

            const xScaleTrend = d3.scaleTime().range([0, 36]).domain([minX, maxX]);
            const yScaleTrend = d3.scaleLinear().range([20 , 0]).domain([minY, maxY]);
            trend_svg
                .datum(state_data)
                .append("path")
                .attr("fill", "none")
                .attr("stroke", color)
                .attr("stroke-width",1.2)
                .attr("d", d3.line()
                    .x(function(d) { 
                      return xScaleTrend(d.date) 
                    })
                    .y(function(d) {  
                      return yScaleTrend(d[variable])
                    })
                )
            }

          })


           
        }
 
    }

    function createDate(day, month, year) {
      const date = new Date(yesterday);
   
      date.setDate(day);
      date.setMonth(parseInt(month, 10) - 1); // jsus
      date.setFullYear(year); // chrst

      return date;
    }
    const datesAreOnSameDay = (first, second) =>
      first.getFullYear() === second.getFullYear() &&
      first.getMonth() === second.getMonth() &&
      first.getDate() === second.getDate();

    async function getCovidDataForState(state) {
      let population = 0;
      let needsDailyDeathCalculation = false;
      let data = [];

      try {
        population = await getPopulationDataForState(state)
        needsDailyDeathCalculation = true;

      } catch(e) {
        console.log(`${state} not found in US NST`)
      }

      let dataus = await getCovidDataUS()
      let dataeu = await getCovidDataEU()
      let datanyc = await getCovidDataNYC()
      let dataTestingUS = await getTestingDataForState(state) // enable for testing data


      // data transformations
      datanyc.forEach(line => {
        if (!line.date) {
          let split = line.DATE_OF_INTEREST.split('/');
          line.date = createDate(split[1], split[0], split[2])
        }
      })
      dataeu.forEach(line => {
        if (!line.date) {
          line.date = createDate(line.day, line.month, line.year);
        }
      })
      dataus.forEach(line => {
        if (typeof line.date === 'string') {
          let split = line.date.split('-');
          line.date = createDate(split[2], split[1], split[0])
        }
      })
      dataTestingUS.forEach(line => {
        if (typeof line.date === 'string') {
          line.date = createDate(line.date.substr(6,2), line.date.substr(4,2),line.date.substr(0,4))
        }
      })

      let dataHospitalUS = [];
      // let dataHospitalUS = await getHospitalDataForState(state) // enable for testing data
      // dataHospitalUS.forEach(line => {
      //   // 13JUN2020
      //   let str = `${line.collectionDate.substr(0,2)}-${line.collectionDate.substr(2,3)}-${line.collectionDate.substr(5,4)}`;// T12:00:00Z
      //     // console.log(str)
      //   line.date = new Date(str)
      // })


      data = dataus.filter(line => line.state === state);
      data.forEach(line => {
        line.testing = dataTestingUS.find(testing => datesAreOnSameDay(testing.date, line.date))
        if (line.testing) {
          line.dailyTestsPerCapita = (line.testing.totalTestResultsIncrease / population) * 1000000;

        }

        line.hospitalCapacity = dataHospitalUS.find(testing => datesAreOnSameDay(testing.date, line.date))
        
        // console.log(dataHospitalUS)
        if (line.hospitalCapacity) {
          line.hospitalCapacity = line.hospitalCapacity.ICUBedsOccAnyPat__N_ICUBeds_Est;
        }
        // if (line.hospital) {
        //   line.dailyHospital = (line.testing.totalTestResultsIncrease / population) * 1000000;

        // }

      })
      // console.log(data, dataTestingUS)
      if (state === 'New York City') {
      
        datanyc.forEach(line => {
          population = 18804000;
          data.push({
            date: line.date,
            state: 'New York City',
            dailyCases: line.CASE_COUNT,
            dailyCasesPerCapita: (line.CASE_COUNT / population) * 1000000,
            dailyDeaths: line.DEATH_COUNT,
            dailyDeathsPerCapita: (line.DEATH_COUNT / population) * 1000000
          })
        })
      }
      dataeu
        .filter(line => line.countriesAndTerritories === state)
        .forEach(line => {
          population = line.popData2019;
          data.push({
            date: line.date,
            state: line.countriesAndTerritories,
            dailyCases: line.cases,
            dailyCasesPerCapita: (line.cases / line.popData2019) * 1000000,
            dailyDeaths: line.deaths,
            dailyDeathsPerCapita: (line.deaths / line.popData2019) * 1000000
          })
      })

      data = data.sort((a,b) => {
            if(a.date == b.date) return 0
            else if(new Date(a.date) > new Date(b.date)) return 1
            else return -1
          });

      if (needsDailyDeathCalculation) {
        data.forEach((day, index) => {
          if (!data[index-1]) {
            day.dailyCases = null;
            day.dailyCasesPerCapita = null;
            day.dailyDeaths = null;
            day.dailyDeathsPerCapita = null;
          } else {
            day.dailyCases = day.cases - data[index-1].cases
            day.dailyCasesPerCapita = (day.dailyCases / population) * 1000000
            day.dailyDeaths = day.deaths - data[index-1].deaths
            day.dailyDeathsPerCapita = (day.dailyDeaths / population) * 1000000
          }
        })

      }

      data.forEach((line, index) => {
        const before = 4;
        const after = 4;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rollingDeaths = average(data.slice(start, end), "dailyDeathsPerCapita")
      })

      data.forEach((line, index) => {
        const before = 4;
        const after = 4;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rollingCases = average(data.slice(start, end), "dailyCasesPerCapita")
      })

      data.forEach((line, index) => {
        const before = 4;
        const after = 4;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rollingTests = average(data.slice(start, end), "dailyTestsPerCapita")
      })

      data = data.filter(day => day.date > lastMonth && day.date <= yesterday);

      return data;
    }



    async function getPopulationDataForState(state) {
      let data = await getPopulationData()
      data = data.filter(line => line.NAME === state)
      return data[0].CENSUS2010POP;
    }

    async function getPopulationData() {
        appState.populationData = appState.populationData
            ? appState.populationData
            : d3.csv("nst-est2019-alldata.csv")
        return await appState.populationData
    }

    async function getTestingDataForState(state) {
      const map = {
        "New York": "NY",
        "Kansas": "KS",
        "Colorado": "CO",
        "Illinois": "IL",
      }
      let data = await getTestingDataUS()
      data = data.filter(line => line.state === map[state])
      return data;
    }

    async function getHospitalDataForState(state) {
      let data = await getHospitalDataUS()
      // console.log(data)
      data = data.filter(line => line.statename === state)
      return data;
    }



    async function getHospitalDataUS() {
        if (!appState.usHospitalData) {
          appState.usHospitalData = d3.csv(`us-hospital.csv?cache=${new Date().getDate()}-${new Date().getHours()}`);
          appState.usHospitalData.then(data => {
            appState.usHospitalData = data;
            renderTotalOverTime(); // XXX terrible
          })
          return await [];
        } else if (appState.usHospitalData instanceof Array) {
          return await appState.usHospitalData
        } else {
          return await [];
        }

    }

    async function getTestingDataUS() {
        if (!appState.usTestingData) {
          appState.usTestingData = d3.csv(`us-testing.csv?cache=${new Date().getDate()}-${new Date().getHours()}`);
          appState.usTestingData.then(data => {
            appState.usTestingData = data;
            renderTotalOverTime(); // XXX terrible
          })
          return await [];
        } else if (appState.usTestingData instanceof Array) {
          return await appState.usTestingData
        } else {
          return await [];
        }

    }

    async function getLastUpdate() {
        return (await d3.csv("lastupdate"))[0]
    }

    async function getCovidDataNYC() {
        appState.covidDataNYC = appState.covidDataNYC
            ? appState.covidDataNYC
            : d3.csv(`nyc.csv?cache=${new Date().getDate()}-${new Date().getHours()}`)

        return await appState.covidDataNYC
    }

    async function getCovidDataUS() {
        appState.covidData = appState.covidData
            ? appState.covidData
            : d3.csv(`us-states.csv?cache=${new Date().getDate()}-${new Date().getHours()}`)

        return await appState.covidData
    }

    async function getCovidDataEU() {
        appState.covidDataEu = appState.covidDataEu
            ? appState.covidDataEu
            : d3.csv(`eu-states.csv?cache=${new Date().getDate()}-${new Date().getHours()}`)

        return await appState.covidDataEu
    }

    function sum(numbers, prop) {
      return numbers.reduce((a, b) => {
        return a + b[prop]
      }, 0);
    }

    function pad(num) {
        var s = num+"";
        while (s.length < 2) s = "0" + s;
        return s;
    }

    function average(numbers, prop) {

      return sum(numbers, prop) / (numbers.length || 1);
    }


</script>
</html>
