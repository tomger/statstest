
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Covid</title>
    <style>
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 2px;
            font-size: 12px;
            background: #eee;
            border: 0px;
            pointer-events: none;
        }
    </style>

</head>
<body>

    <div class="graph">
        <h2>2-Daily Rolling Avg CoVid-19 deaths per 1M People</h2>
        <svg id="state_total_time"> </svg>
    </div>

</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
    const appState = {
        covidData: null,
        populationData: null
    };

    renderTotalOverTime();
    // renderTotalOverTime("Washington");

    function formateDate (date) {
        const d = new Date(date);
        return `${(d.getMonth() + 1)}.${ (d.getDate() + 1)}.${d.getFullYear()}`
    }


    const tooltipDiv = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

    window.onresize = function () {
        renderTotalOverTime(appState.currentState);
    }


    async function renderTotalOverTime () {
        const variable = "rolling";
        const states = ["Vermont", "Illinois"]
        const colors = ["#5b95f6", "#db4437", "#50C8C8"]
        let data = await getCovidDataForState(states[0]);

        const {x,y,width,height,margin} = getBounds();

        var state_svg = d3.select("#state_total_time")
        .html("")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");

        let maxY = 0;
        for (let i = 0; i < states.length; i++) {
          let stateData = await getCovidDataForState(states[i])
          let stateMax = d3.max(stateData, function(d) { return parseInt(d[variable], 10); })
          maxY = Math.max(maxY, stateMax)
        }

        // Scale the range of the data in the domains
        x.domain(data.map(function(d) { return d.date; }));
        y.domain([0, maxY]);


        for (let i = 0; i < states.length; i++) {

           let state_data = await getCovidDataForState(states[i]);
           console.log(i,state_data)
           state_svg
               .datum(state_data)
               // .enter()
               .append("path")
               .attr("fill", "none")
               .attr("stroke", colors[i])
               .attr("stroke-width", 1.5)
               .attr("d", d3.line()
                   .x(function(d) { return x(d.date) })
                   .y(function(d) {
                      return y(d[variable])
                    })
               )

           state_svg
               .append('g')
               .selectAll("dot")
               .data(state_data)
               .enter()
               .append("circle")
               .attr("cx", function (d) { return x(d.date); } )
               .attr("cy", function (d) { return y(d[variable]); } )
               .attr("r", 4)
               .style("fill", colors[i])
               .on("mouseover", function(d) {
                   tooltipDiv.transition()
                       .duration(200)
                       .style("opacity", .9);
                   tooltipDiv.html(states[i] + "<br/>" + d.date + "<br/>"  + d[variable])
                       .style("left", (d3.event.pageX) + "px")
                       .style("top", (d3.event.pageY - 28) + "px");
                   })
               .on("mouseout", function(d) {
                   tooltipDiv.transition()
                       .duration(500)
                       .style("opacity", 0);
               });
        }


        // add the x Axis
        state_svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).tickFormat(formateDate))
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", function(d) {
                return "rotate(-65)"
                });

        // add the y Axis
        state_svg.append("g")
            .call(d3.axisLeft(y));


        // })
    }


    function getBounds() {
        const margin = {top: 20, right: 40, bottom: 60, left: 70};
        const width = window.innerWidth - 48 - margin.left - margin.right;
        const height = 410 - margin.top - margin.bottom;

        const x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);

        const y = d3.scaleLinear()
                .range([height, 0]);
        return {x,y,width,height,margin};
    }

    async function getPopulationDataForState(state) {
      let data = await getPopulationData()
      data = data.filter(line => line.NAME === state)
      return data[0].CENSUS2010POP;
    }

    async function getPopulationData(state) {
        appState.populationData = appState.populationData
            ? appState.populationData
            : d3.csv("nst-est2019-alldata.csv")
        return await appState.populationData
    }

    async function getCovidDataForState(state) {
      // death data is cummulative
      let data = await getCovidData()
      data = data.filter(line => line.state === state)
      // .sort((a,b) => {
      //     if(a.date == b.date) return 0
      //     else if(a.date > b.date) return 1
      //     else return -1
      //   });

      let population = await getPopulationDataForState(state)
      data.forEach((day, index) => {
        if (!data[index-1]) {
          day.dailyDeaths = 0
          day.dailyDeathsPerCapita = 0
        } else {
          day.dailyDeaths = day.deaths - data[index-1].deaths
          day.dailyDeathsPerCapita = (day.dailyDeaths / population) * 1000000
        }

      })


      data.forEach((line, index) => {
        const before = 2;
        const after = 2;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rolling = average(data.slice(start, end))
      })

      return data;
    }

    async function getCovidData() {
        appState.covidData = appState.covidData
            ? appState.covidData
            : d3.csv("us-states.csv")

        return await appState.covidData
    }

    function sum(numbers) {
      return numbers.reduce((a, b) => {
        return a + b.dailyDeathsPerCapita
      }, 0);
    }

    function average(numbers) {

      return sum(numbers) / (numbers.length || 1);
    }


</script>
</html>
