
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Covid</title>
    <style>
        body {
          font-family: sans-serif;
        }
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 6px;
            padding-right: 20px;
            font-size: 12px;
            color: #fff;
            background: #000;
            border: 0px;
            pointer-events: none;
            font-weight: 300;
        }
        svg {overflow: visible}
        h2 {

        }
        .menu {
          max-width: 700px;
        }
        .menuItem {
          border-bottom: 1px solid #eee;
          line-height: 48px;
          padding: 0 8px;
          display: block;
          font-size: 16px;
          font-weight: 300;
          cursor: pointer;
          user-select: none;
          color: #000;
          text-decoration: none;

          overflow: hidden;

        }
        .menuItem:hover {
          background: #eee
        }
        .menuItem.selected {
          background: #000;
          color: #fff;
          border-color: #000;
        }

        .axis line {
          stroke: #fff;
        }
        .axis .domain{
          stroke: #111
        }
        .axis {
          font-size: 14px;
          font-weight: 300;
          color: #111;
        }
        .y-axis .domain{
          stroke: #fff;
          /* text-anchor: start; */
        }
        body, html {
          padding: 0; margin: 0
        }
        .graph {
          background: #fff;
          padding: 20px 10px 40px 10px;
        }
        .graph svg{
          margin: 0px auto 40px; auto;
          /* transform: translateX(-100px); */
          display: block;
        }
        .menu {
          position: absolute;
          top: 0;
          z-index: 2;
          display: none;
          padding: 10px;
          background: #fafafa;
          width: 100%;
        }
        .button {
          line-height: 40px;
          padding: 0 14px;
          border: 1px solid #eee;
          border-radius: 8px;
          margin-right: 8px
        }
        .titlebar {
          background: #fff;
          text-align: center;
          line-height: 44px;
          border-bottom: 1px solid #ccc;
          font-weight: 400;
          font-size: 16px;
        }
        .legend {
          font-size: 14px;
          font-weight: 300;
          line-height: 32px;
        }
        .legend > div {
          border-bottom: 1px solid #ccc;
        }
    </style>

</head>
<body>
    <div class="menu"></div>
      <div style="position:fixed;">
      <div class="titlebar">Corona tracker</div>
      <div class="graph">
          <svg class="state_total_time"> </svg>
          <div class="legend"></div>
          <select class="state_selector" onChange="toggleState(this.value)"></select>
      </div>
      </div>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
    const appState = {
        covidData: null,
        populationData: null,
        selectedStates: ["New York", "Belgium"]
    };
    try {
      let storage =  localStorage.getItem('states0');
      if (!storage) {
        appState.selectedStates = [];
      } else {
        appState.selectedStates = localStorage.getItem('states0').split(',')
      }
    } catch(e) {}

    renderTotalOverTime();
    // renderTotalOverTime("Washington");
    renderMenu();
    function toggleState(state) {
      if (!state) {
        return
      }
      let index = appState.selectedStates.indexOf(state);
      if (index === -1) {
        appState.selectedStates.push(state)
      } else {
        appState.selectedStates.splice(index, 1)
      }
      localStorage.setItem('states0', appState.selectedStates)
      renderMenu()
      renderTotalOverTime();
    }

    async function renderMenu() {
      let statesMenu = [
        ...new Set((await getCovidDataUS()).map(line => line.state)),
        ...new Set((await getCovidDataEU()).map(line => line.countriesAndTerritories))
      ].sort();

      list = statesMenu
        .filter((name) => appState.selectedStates.indexOf(name) === -1)
        .map(function(name){
          return `<option value="${name}">${name}</option>`;
        }).join('')
        d3.select(".state_selector").html(`<option value="">Add a state</option>` + list)
    }

    // function resetMenu() {
    //   appState.selectedStates = [];
    //   localStorage.setItem('states0', appState.selectedStates)
    //   renderMenu();
    //   renderTotalOverTime();
    // }


    const tooltipDiv = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

    window.onresize = function () {
        renderTotalOverTime(appState.currentState);
    }


    async function renderTotalOverTime () {
        const formatDate = d3.timeFormat("%B %e");
        const width = Math.min(700, document.body.offsetWidth);
        const height = 200;
        let states = appState.selectedStates;
        // const colors = ["#510000", "#879772", "#325d8a", "#6C6ACB", "#DF9F22",]
        const colors = ["#2E4F60","#226C5B","#637F3E","#B5843D"];
        // const colors = ["#000", "#000", "#000", "#000", "#879772",]
        let data = await getCovidDataForState(states[0]);


        var state_svg = d3.select(".state_total_time")
          .html("")
          .attr("width", width )
          .attr("height", height)
              // .append("g")
              //     .attr("transform",
              //         "translate(" + margin.left + "," + margin.top + ")");

        let maxY = 0;
        let maxY2 = 0;
        let minX = new Date("2222-01-01");
        let maxX = new Date("1900-01-01");

        var legendHtml = []

        for (let i = 0; i < states.length; i++) {
          let stateData = await getCovidDataForState(states[i])

          maxX = Math.max(maxX, d3.max(stateData, function(d) { return d.date; }));
          minX = Math.min(minX, d3.min(stateData, function(d) { return d.date; }));
          maxY = Math.max(maxY, d3.max(stateData, function(d) { return d.rollingDeaths; }))
          maxY2 = Math.max(maxY2, d3.max(stateData, function(d) { return d.rollingCases; }))
        }
        // console.log("any?",[new Date(minX), new Date(maxX)])
        // const xScale =
        //         d3.scaleBand()
        //           .range([0, width])
        //           .domain(data.map(function(d) {
        //             return d.date;
        //           }));

        const colorScale = d3.scaleOrdinal(d3.schemeCategory10).domain(states);

        const xScale =
                d3.scaleTime()
                  .range([0, width -50])
                  .domain([minX, maxX]);

        const yScale = d3.scaleLinear()
                .range([height , 0])
                .domain([0, maxY]);
        const yScale2 = d3.scaleLinear()
                .range([height , 0])
                .domain([0, maxY2]);

        state_svg.append("g")
            .attr("class", "axis x-axis")
            .attr("transform", "translate(0," + (height) + ")")
            .call(d3.axisBottom(xScale)
              .tickValues( xScale.ticks( 0 ).concat( xScale.domain() ) )
              .tickFormat(formatDate))
        state_svg.selectAll(".x-axis .tick text").style("text-anchor", "start")
        state_svg.selectAll(".x-axis .tick:last-child text").style("text-anchor", "end")

        let yTicks =  yScale.ticks( 3 );

        state_svg.append("g")
            .attr("class", "axis y-axis")
            .attr("transform", `translate(${width-50}, 0)`)
            .call(d3.axisRight(yScale).tickValues(yTicks ));

        yTicks.forEach((tick) => {
          state_svg
              .datum([minX, maxX])
              .append("path")
              .attr("fill", "none")
              .attr("stroke", "#000")
              .attr("opacity", .05)
              // .attr("stroke-dasharray",4)
              .attr("stroke-width", 1)
              .attr("d", d3.line()
                  .x(function(d) { return xScale(d) })
                  .y(function(d) { return yScale(tick) })
              )
        });




// console.log('bananas', d3.timeDay.range(new Date(minX), new Date(maxX), 1));

         // state_svg
         //    .append("text")
         // 		.attr("transform", "translate(0,15)")
         // 		.attr("text-anchor", "start")
         // 		.style("fill", "#000")
         // 		.style("font-size", "12px")
         // 		.style("font-weight", 600)
         // 		.html(`Coronavirus impact`);

        for (let i = 0; i < states.length; i++) {

           let state_data = await getCovidDataForState(states[i]);

           legendHtml.push([state_data[state_data.length-1].rolling,
            `<div style="" onClick="toggleState('${states[i]}')">
                <div style="height: 20px; width: 20px; background-color: ${colorScale(states[i])}; display: inline-block;"></div>
                ${states[i]}
                ${Math.round(state_data[state_data.length-1].rollingDeaths)} deaths/1M on ${formatDate(state_data[state_data.length-1].date)}
              </div>`
           ]);
           state_svg
               .datum(state_data)
               // .enter()
               .append("path")
               .attr("fill", "none")
               .attr("stroke", colorScale(states[i]))
               .attr("stroke-width", 1.8)
               .attr("d", d3.line()
                   .x(function(d) { return xScale(d.date) })
                   .y(function(d) {
                      return yScale(d.rollingDeaths)
                    })
               )
             state_svg
                 .datum(state_data)
                 // .enter()
                 .append("path")
                 .attr("fill", "none")
                 .attr("stroke",  colorScale(states[i]))
                 .attr("stroke-dasharray", 2)
                 .attr("stroke-width", 1)
                 .attr("d", d3.line()
                     .x(function(d) { return xScale(d.date) })
                     .y(function(d) {
                        return yScale2(d.rollingCases)
                      })
                 )

           // state_svg
           //     .datum(state_data)
           //     .append("path")
           //     .attr("fill", colors[i])
           //     .attr("opacity", .02)
           //     .attr("d", d3.area()
           //         .x(function(d) { return xScale(d.date) })
           //         .y0(height)
           //         .y1(function(d) { return yScale(d[variable]); })
           //     )



           // state_svg
           //    .append("text")
           // 		.attr("transform", "translate(" + (xScale(maxX) + 10) + "," + yScale(state_data[state_data.length-1][variable]) + ")")
           // 		.attr("dy", ".35em")
           // 		.attr("text-anchor", "start")
           // 		.style("fill", "#000")
           // 		.style("font-size", "12px")
           // 		.style("font-weight", 300)
           // 		.html(`<tspan style="font-weight: 600">${states[i]}</tspan><tspan x="0" dy="15" >${Math.round(state_data[state_data.length-1].dailyDeathsPerCapita)} deaths/1M on ${formatDate(state_data[state_data.length-1].date)}</tspan>`);

        }
        legendHtml.sort((a,b) => b[0] - a[0])
        d3.select(".legend").html(legendHtml.map(a => a[1]).join(''));

    }

    async function getCovidDataForState(state) {
      let population = 0;
      let needsDailyDeathCalculation = false;
      let data = [];

      try {
        population = await getPopulationDataForState(state)
        needsDailyDeathCalculation = true;

      } catch(e) {
        console.log("not found in US NST")
      }

      let dataus = await getCovidDataUS()
      // XXX US death data is cummulative
      // date: "2020-02-25"
      // state: "Wisconsin"
      // fips: "55"
      // cases: "1"
      // deaths: "0"

      let dataeu = await getCovidDataEU()
      // dateRep: "29/03/2020"
      // day: "29"
      // month: "3"
      // year: "2020"
      // cases: "11"
      // deaths: "1"
      // countriesAndTerritories: "Albania"
      // geoId: "AL"
      // countryterritoryCode: "ALB"
      // popData2018: "2866376"

      // let dataTestingUS = await getTestingDataForState(state)
      // dataTestingUS.forEach(line => {
      //   // 20200430
      //   if (line.date.substr) {
      //     line.date = new Date(`${line.date.substr(0,4)}-${line.date.substr(4,2)}-${line.date.substr(6,2)}`)
      //   }
      // })


      data = dataus.filter(line => line.state === state);
      data.forEach(line => {
        line.date = new Date(line.date)
        // line.testing = dataTestingUS.find(testing => testing.date.getTime() == line.date.getTime())
        // if (line.testing) {
        //   line.testsPerDay = line.testing.totalTestResultsIncrease / population;

        // }
      })
      // console.log(data, dataTestingUS)
      dataeu
        .filter(line => line.countriesAndTerritories === state)
        .forEach(line => {
          population = line.popData2018;
          data.push({
            date: new Date(`${line.year}-${pad(line.month)}-${pad(line.day)}`),
            state: line.countriesAndTerritories,
            dailyCases: line.cases,
            dailyCasesPerCapita: (line.cases / line.popData2018) * 1000000,
            dailyDeaths: line.deaths,
            dailyDeathsPerCapita: (line.deaths / line.popData2018) * 1000000
          })
      })

      data = data.sort((a,b) => {
            if(a.date == b.date) return 0
            else if(new Date(a.date) > new Date(b.date)) return 1
            else return -1
          });

      if (needsDailyDeathCalculation) {
        data.forEach((day, index) => {
          if (!data[index-1]) {
            day.dailyCases = null;
            day.dailyCasesPerCapita = null;
            day.dailyDeaths = null;
            day.dailyDeathsPerCapita = null;
          } else {
            day.dailyCases = day.cases - data[index-1].cases
            day.dailyCasesPerCapita = (day.dailyCases / population) * 1000000
            day.dailyDeaths = day.deaths - data[index-1].deaths
            day.dailyDeathsPerCapita = (day.dailyDeaths / population) * 1000000
          }
        })

      }

      data.forEach((line, index) => {
        const before = 8;
        const after = 1;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rollingDeaths = average(data.slice(start, end), "dailyDeathsPerCapita")
      })

      data.forEach((line, index) => {
        const before = 8;
        const after = 1;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rollingCases = average(data.slice(start, end), "dailyCasesPerCapita")
      })

      let dayCutOff = 80;
      let cutOff = Date.now() - dayCutOff *  24*60*60*1000;
      data = data.filter(day => new Date(day.date) > cutOff)


      return data;
    }



    async function getPopulationDataForState(state) {
      let data = await getPopulationData()
      data = data.filter(line => line.NAME === state)
      return data[0].CENSUS2010POP;
    }

    async function getPopulationData() {
        appState.populationData = appState.populationData
            ? appState.populationData
            : d3.csv("nst-est2019-alldata.csv")
        return await appState.populationData
    }

    async function getTestingDataForState(state) {
      const map = {
        "New York": "NY"
      }
      let data = await getTestingDataUS()
      data = data.filter(line => line.state === map[state])
      return data;
    }

    async function getTestingDataUS() {
        appState.usTestingData = appState.usTestingData
            ? appState.usTestingData
            : d3.csv("us-testing.csv?rnd=" + Date.now())

        return await appState.usTestingData
    }

    async function getCovidDataUS() {
        appState.covidData = appState.covidData
            ? appState.covidData
            : d3.csv("us-states.csv?rnd=" + Date.now())

        return await appState.covidData
    }

    async function getCovidDataEU() {
        appState.covidDataEu = appState.covidDataEu
            ? appState.covidDataEu
            : d3.csv("eu-states.csv?rnd=" + Date.now())

        return await appState.covidDataEu
    }

    function sum(numbers, prop) {
      return numbers.reduce((a, b) => {
        return a + b[prop]
      }, 0);
    }

    function pad(num) {
        var s = num+"";
        while (s.length < 2) s = "0" + s;
        return s;
    }

    function average(numbers, prop) {

      return sum(numbers, prop) / (numbers.length || 1);
    }


</script>
</html>
