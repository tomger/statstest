
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Covid</title>
    <style>
        body {
          font-family: sans-serif;
        }
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 6px;
            padding-right: 20px;
            font-size: 12px;
            color: #fff;
            background: #000;
            border: 0px;
            pointer-events: none;
            font-weight: 300;
        }
        svg {overflow: visible}
        h2 {

        }
        .menu {
          max-width: 700px;
        }
        .menuItem {
          border: 1px solid #eee;
          padding: 5px 10px;
          border-radius: 100px;
          display: inline-block;
          font-size: 12px;
          margin-right: 4px;
          margin-bottom: 4px;
          font-weight: 300;
          cursor: pointer;
          user-select: none;
          color: #000;
          text-decoration: none;
        }
        .menuItem:hover {
          background: #eee
        }
        .menuItem.selected {
          background: #000;
          color: #fff;
          border-color: #000;
        }
    </style>

</head>
<body>

      <div class="graph">
          <h2>CoVid-19: Daily reported deaths per 1M people</h2>
          <h4>Rolling 2 day average</h4>
          <svg id="state_total_time"> </svg>
      </div>
      <div class="menu"></div>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
    const appState = {
        covidData: null,
        populationData: null,
        selectedStates: ["New York"]//["Italy", "Belgium", "Netherlands", "Germany", "California", "New York" , "Japan"]
    };

    renderTotalOverTime();
    // renderTotalOverTime("Washington");
    renderMenu();

    async function renderMenu() {
      let statesMenu = [
        ...new Set((await getCovidDataUS()).map(line => line.state)),
        ...new Set((await getCovidDataEU()).map(line => line.countriesAndTerritories))
      ].sort();
      list = statesMenu
        .map(function(name){
          let selected = appState.selectedStates.indexOf(name) !== -1 ? "selected" : "";
          return `<a href="#" onClick="toggleMenu('${name}')" class="menuItem ${selected}">${name}</a>`;
        })
        .join('')
      d3.select(".menu")
        .html(`<span onClick="resetMenu()" class="menuItem">Reset</span>` +list)
    }

    function resetMenu() {
      appState.selectedStates = [];
      renderMenu();
      renderTotalOverTime();
    }
    function toggleMenu(state) {
      let index = appState.selectedStates.indexOf(state);
      if (index === -1) {
        appState.selectedStates.push(state)
      } else {
        appState.selectedStates.splice(index, 1)
      }
      renderMenu();
      renderTotalOverTime();
    }

    function formateDate (date) {
         const d = date.split('-')
         return `${(d[1])}/${ (d[2])}`
     }


    const tooltipDiv = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

    window.onresize = function () {
        renderTotalOverTime(appState.currentState);
    }


    async function renderTotalOverTime () {
        const margin = {top: 20, right: 100, bottom: 60, left: 30};
        const width = document.querySelector(".graph").offsetWidth - 48 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;
        const variable = "rolling";
        let states = appState.selectedStates;
        const colors = ["#000","#5b95f6", "#db4437", "#50C8C8", "#6C6ACB", "#DF9F22", "#000", "#000", "#000"]
        let data = await getCovidDataForState(states[0]);

        var state_svg = d3.select("#state_total_time")
          .html("")
          .attr("width", width )
          .attr("height", height + margin.top + margin.bottom)
              .append("g")
                  .attr("transform",
                      "translate(" + margin.left + "," + margin.top + ")");

        let maxY = 0;
        let minX = new Date("2222-01-01");
        let maxX = new Date("1900-01-01");

        for (let i = 0; i < states.length; i++) {
          let stateData = await getCovidDataForState(states[i])

          maxX = Math.max(maxX, d3.max(stateData, function(d) { return new Date(d.date); }));
          minX = Math.min(minX, d3.min(stateData, function(d) { return new Date(d.date); }));
          maxY = Math.max(maxY, d3.max(stateData, function(d) { return d[variable]; }))
        }
        // console.log("any?",[new Date(minX), new Date(maxX)])
        const xScale =
                d3.scaleBand()
                  .range([0, width])
                  .domain(data.map(function(d) { return d.date; }));
                  // .domain([new Date(minX), new Date(maxX)]);
                // d3.scaleTime()
                // .paddingInner(0)
                // .align(0.5)

        const yScale = d3.scaleLinear()
                .range([height, 0])
                .domain([0, maxY]);

// console.log('bananas', d3.timeDay.range(new Date(minX), new Date(maxX), 1));

        for (let i = 0; i < states.length; i++) {

           let state_data = await getCovidDataForState(states[i]);
           // console.log(i,state_data)
           state_svg
               .datum(state_data)
               // .enter()
               .append("path")
               .attr("fill", "none")
               .attr("stroke", colors[i])
               .attr("stroke-width", 1.5)
               .attr("d", d3.line()
                   .x(function(d) { return xScale(d.date) })
                   .y(function(d) {
                      return yScale(d[variable])
                    })
               )

           state_svg
              .append("text")
           		.attr("transform", "translate(" + (width-10) + "," + yScale(state_data[state_data.length-1][variable]) + ")")
           		.attr("dy", ".35em")
           		.attr("text-anchor", "start")
           		.style("fill", colors[i])
           		.style("font-size", "12px")
           		.style("font-weight", 300)
           		.html(states[i]);

           state_svg
               .append('g')
               .selectAll("dot")
               .data(state_data)
               .enter()
               .append("circle")
               .attr("cx", function (d) { return xScale(d.date); } )
               .attr("cy", function (d) { return yScale(d[variable]); } )
               .attr("r", 4)
               .style("fill", "white")
               .style("stroke", colors[i])
               .on("mouseover", function(d) {
                   // this.style.opacity = 1;
                   tooltipDiv.transition()
                       .duration(200)
                       .style("opacity", .9);
                   tooltipDiv.html(`<b>${states[i]}</b><br/>${d.date}<br/><br/>${Math.round(d[variable]*100)/100} Deaths/Mil<br/>${d.dailyDeaths} Deaths`)
                       .style("left", (d3.event.pageX + 10) + "px")
                       .style("top", (d3.event.pageY - 0) + "px");
                   })
               .on("mouseout", function(d) {
                   tooltipDiv.transition()
                       .duration(500)
                       .style("opacity", 0);
               });
        }



        state_svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(xScale).tickFormat(formateDate))
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", function(d) {
                return "rotate(-65)"
                });

        // add the y Axis
        state_svg.append("g")
            .call(d3.axisLeft(yScale));


        // })
    }



    async function getPopulationDataForState(state) {
      let data = await getPopulationData()
      data = data.filter(line => line.NAME === state)
      return data[0].CENSUS2010POP;
    }

    async function getPopulationData(state) {
        appState.populationData = appState.populationData
            ? appState.populationData
            : d3.csv("nst-est2019-alldata.csv")
        return await appState.populationData
    }

    async function getCovidDataForState(state) {
      let population = 0;
      let needsDailyDeathCalculation = false;
      let data = [];

      try {
        population = await getPopulationDataForState(state)
        needsDailyDeathCalculation = true;

      } catch(e) {
        console.log("not found in US NST")
      }

      let dataus = await getCovidDataUS()
      // XXX US death data is cummulative
      // date: "2020-02-25"
      // state: "Wisconsin"
      // fips: "55"
      // cases: "1"
      // deaths: "0"

      let dataeu = await getCovidDataEU()
      // dateRep: "29/03/2020"
      // day: "29"
      // month: "3"
      // year: "2020"
      // cases: "11"
      // deaths: "1"
      // countriesAndTerritories: "Albania"
      // geoId: "AL"
      // countryterritoryCode: "ALB"
      // popData2018: "2866376"



      data = dataus.filter(line => line.state === state);

      dataeu
        .filter(line => line.countriesAndTerritories === state)
        .forEach(line => {
          population = line.popData2018;
          data.push({
            date: `${line.year}-${pad(line.month)}-${pad(line.day)}`,
            state: line.countriesAndTerritories,
            dailyDeaths: line.deaths,
            dailyDeathsPerCapita: (line.deaths / line.popData2018) * 1000000
          })
      })

      data = data.sort((a,b) => {
            if(a.date == b.date) return 0
            else if(new Date(a.date) > new Date(b.date)) return 1
            else return -1
          });

      if (needsDailyDeathCalculation) {
        data.forEach((day, index) => {
          if (!data[index-1]) {
            day.dailyDeaths = null;
            day.dailyDeathsPerCapita = null;
          } else {
            day.dailyDeaths = day.deaths - data[index-1].deaths
            day.dailyDeathsPerCapita = (day.dailyDeaths / population) * 1000000
          }
        })

      }


      console.log(state, data);

      data.forEach((line, index) => {
        const before = 0;
        const after = 0;
        const start = Math.max(0, index - before);
        const end   = Math.min(data.length, index + after + 1);
        line.rolling = average(data.slice(start, end))
      })

      let dayCutOff = 20;
      let cutOff = Date.now() - dayCutOff *  24*60*60*1000;
      data = data.filter(day => new Date(day.date) > cutOff)


      return data;
    }

    async function getCovidDataUS() {
        appState.covidData = appState.covidData
            ? appState.covidData
            : d3.csv("us-states.csv?rnd=" + Date.now())

        return await appState.covidData
    }

    async function getCovidDataEU() {
        appState.covidDataEu = appState.covidDataEu
            ? appState.covidDataEu
            : d3.csv("eu-states.csv?rnd=" + Date.now())

        return await appState.covidDataEu
    }

    function sum(numbers) {
      return numbers.reduce((a, b) => {
        return a + b.dailyDeathsPerCapita
      }, 0);
    }

    function pad(num) {
        var s = num+"";
        while (s.length < 2) s = "0" + s;
        return s;
    }

    function average(numbers) {

      return sum(numbers) / (numbers.length || 1);
    }


</script>
</html>
